{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://fcbase.org/schema/controller.json",
  "title": "FCBase Controller Schema",
  "type": "object",
  "additionalProperties": false,
  "definitions": {
    "voltageRange": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "min": { "type": "number" },
        "max": { "type": "number" },
        "nominal": { "type": "number" },
        "cells": {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "min": { "type": "integer", "minimum": 1 },
            "max": { "type": "integer", "minimum": 1 }
          },
          "anyOf": [
            { "required": ["min"] },
            { "required": ["max"] }
          ]
        },
        "unit": { "type": "string", "enum": ["V"] },
        "notes": { "type": "string" }
      },
      "anyOf": [
        { "required": ["min"] },
        { "required": ["max"] },
        { "required": ["nominal"] },
        { "required": ["cells"] },
        { "required": ["notes"] }
      ]
    },
    "currentSpec": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "continuous": { "type": "number" },
        "peak": { "type": "number" },
        "max": { "type": "number" },
        "unit": { "type": "string", "enum": ["A"] },
        "notes": { "type": "string" }
      },
      "anyOf": [
        { "required": ["continuous"] },
        { "required": ["peak"] },
        { "required": ["max"] },
        { "required": ["notes"] }
      ]
    },
    "powerInput": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name"],
      "properties": {
        "name": { "type": "string" },
        "type": {
          "type": "string",
          "enum": ["power_module", "usb", "battery", "regulator", "servo_rail", "other"]
        },
        "connector": { "type": "string" },
        "voltage": { "$ref": "#/definitions/voltageRange" },
        "current": { "$ref": "#/definitions/currentSpec" },
        "notes": { "type": "string" }
      },
      "anyOf": [
        { "required": ["voltage"] },
        { "required": ["notes"] }
      ]
    },
    "peripheral": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "type"],
      "properties": {
        "name": { "type": "string" },
        "type": {
          "type": "string",
          "enum": [
            "uart",
            "gps",
            "i2c",
            "spi",
            "can",
            "usb",
            "power",
            "pwm",
            "rc",
            "analog",
            "debug",
            "video",
            "led",
            "buzzer",
            "ethernet",
            "storage",
            "other"
          ]
        },
        "count": { "type": "integer", "minimum": 1 },
        "interfaces": {
          "type": "array",
          "items": { "type": "string", "pattern": "^[a-z0-9_\-]+$" },
          "minItems": 1
        },
        "connector": { "type": "string" },
        "voltage": { "type": "string" },
        "notes": { "type": "string" }
      }
    },
    "peripheralPort": {
      "type": "object",
      "additionalProperties": false,
      "required": ["port", "type"],
      "properties": {
        "port": { "type": "string" },
        "type": {
          "type": "string",
          "enum": [
            "uart",
            "i2c",
            "can",
            "power",
            "usb",
            "ethernet",
            "pwm",
            "spi",
            "rc",
            "gps",
            "analog",
            "debug",
            "other"
          ]
        },
        "default_use": { "type": "string" },
        "voltage": { "type": "string" },
        "connector": { "type": "string" },
        "notes": { "type": "string" }
      }
    },
    "ioBase": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "uarts": { "type": "integer", "minimum": 0 },
        "can": { "type": "integer", "minimum": 0 },
        "pwm": { "type": "integer", "minimum": 0 },
        "ethernet": { "type": "boolean" },
        "sd_card": { "type": "boolean" },
        "peripherals": {
          "type": "array",
          "items": { "$ref": "#/definitions/peripheral" }
        }
      }
    },
    "ioSpec": {
      "allOf": [
        { "$ref": "#/definitions/ioBase" },
        { "required": ["uarts", "can", "pwm", "sd_card"] }
      ]
    },
    "ioOverride": {
      "$ref": "#/definitions/ioBase"
    },
    "powerBase": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "voltage_in": { "type": "string" },
        "inputs": {
          "type": "array",
          "items": { "$ref": "#/definitions/powerInput" },
          "minItems": 1
        },
        "redundant": { "type": "boolean" },
        "notes": { "type": "string" }
      }
    },
    "powerSpec": {
      "allOf": [
        { "$ref": "#/definitions/powerBase" },
        {
          "anyOf": [
            { "required": ["voltage_in"] },
            { "required": ["inputs"] }
          ]
        }
      ]
    },
    "powerOverride": {
      "$ref": "#/definitions/powerBase"
    },
    "linkEntry": {
      "anyOf": [
        { "type": "string", "format": "uri" },
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["url"],
          "properties": {
            "url": { "type": "string", "format": "uri" },
            "label": { "type": "string" },
            "description": { "type": "string" }
          }
        }
      ]
    },
    "knownIssue": {
      "type": "object",
      "additionalProperties": false,
      "required": ["title", "severity", "date", "source"],
      "properties": {
        "id": { "type": "string" },
        "title": { "type": "string" },
        "severity": {
          "type": "string",
          "enum": ["info", "low", "medium", "high", "critical"]
        },
        "date": {
          "type": "string",
          "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"
        },
        "source": { "type": "string" },
        "url": { "type": "string", "format": "uri" },
        "description": { "type": "string" }
      }
    },
    "links": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "docs": { "$ref": "#/definitions/linkEntry" },
        "pinout": { "$ref": "#/definitions/linkEntry" },
        "vendor": { "$ref": "#/definitions/linkEntry" },
        "github": { "$ref": "#/definitions/linkEntry" }
      }
    },
    "sensorEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id"],
      "properties": {
        "id": { "type": "string" },
        "count": { "type": "integer", "minimum": 1 },
        "notes": { "type": "string" }
      }
    },
    "sensorsSpec": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "imu": {
          "type": "array",
          "items": { "$ref": "#/definitions/sensorEntry" }
        },
        "barometer": {
          "type": "array",
          "items": { "$ref": "#/definitions/sensorEntry" }
        },
        "magnetometer": {
          "type": "array",
          "items": { "$ref": "#/definitions/sensorEntry" }
        }
      }
    },
    "revisionOverrides": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "sensors": { "$ref": "#/definitions/sensorsSpec" },
        "io": { "$ref": "#/definitions/ioOverride" },
        "power": { "$ref": "#/definitions/powerOverride" },
        "peripheral_ports": {
          "type": "array",
          "items": { "$ref": "#/definitions/peripheralPort" }
        }
      },
      "anyOf": [
        { "required": ["sensors"] },
        { "required": ["io"] },
        { "required": ["power"] },
        { "required": ["peripheral_ports"] }
      ]
    }
  },
  "required": [
    "id",
    "title",
    "brand",
    "mcu",
    "mounting",
    "power",
    "io",
    "hardware",
    "sensors",
    "firmware_support",
    "sources",
    "verification",
    "keywords"
  ],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^[a-z0-9]+(?:-[a-z0-9]+)*$"
    },
    "title": { "type": "string" },
    "brand": { "type": "string" },
    "mcu": { "type": "string" },
    "mounting": {
      "type": "string",
      "enum": ["20x20", "25.5x25.5", "30.5x30.5", "35x35", "cube", "wing", "custom"]
    },
    "dimensions": {
      "type": "object",
      "additionalProperties": false,
      "required": ["width_mm", "length_mm"],
      "properties": {
        "width_mm": { "type": "number" },
        "length_mm": { "type": "number" },
        "height_mm": { "type": "number" },
        "weight_g": { "type": "number" }
      }
    },
    "power": { "$ref": "#/definitions/powerSpec" },
    "io": { "$ref": "#/definitions/ioSpec" },
    "peripheral_ports": {
      "type": "array",
      "items": { "$ref": "#/definitions/peripheralPort" }
    },
    "hardware": {
      "type": "object",
      "additionalProperties": false,
      "required": ["openness"],
      "properties": {
        "openness": {
          "type": "string",
          "enum": ["open", "closed", "mixed"]
        },
        "notes": { "type": "string" },
        "revisions": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["id", "name"],
            "properties": {
              "id": {
                "type": "string",
                "pattern": "^[a-z0-9]+(?:-[a-z0-9]+)*$"
              },
              "name": { "type": "string" },
              "released": {
                "type": "string",
                "pattern": "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"
              },
              "notes": { "type": "string" },
              "changes": {
                "type": "array",
                "items": { "type": "string" },
                "minItems": 1
              },
              "sources": {
                "type": "array",
                "items": { "type": "string" },
                "minItems": 1
              },
              "overrides": {
                "$ref": "#/definitions/revisionOverrides"
              }
            },
            "anyOf": [
              { "required": ["notes"] },
              { "required": ["changes"] },
              { "required": ["released"] }
            ]
          }
        }
      }
    },
    "sensors": { "$ref": "#/definitions/sensorsSpec" },
    "features": {
      "type": "array",
      "items": { "type": "string" }
    },
    "firmware_support": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["id", "status"],
        "properties": {
          "id": { "type": "string" },
          "status": { "type": "string", "enum": ["beta", "stable", "deprecated", "community"] }
        }
      }
    },
    "known_issues": {
      "type": "array",
      "items": { "$ref": "#/definitions/knownIssue" }
    },
    "links": { "$ref": "#/definitions/links" },
    "sources": {
      "type": "array",
      "minItems": 1,
      "items": { "type": "string" }
    },
    "verification": {
      "type": "object",
      "additionalProperties": false,
      "required": ["level", "last_updated"],
      "properties": {
        "level": { "type": "string", "enum": ["unverified", "community", "reviewed"] },
        "last_updated": { "type": "string", "format": "date" }
      }
    },
    "keywords": {
      "type": "array",
      "items": { "type": "string" },
      "uniqueItems": true
    },
    "notes": { "type": "string" }
  }
}
