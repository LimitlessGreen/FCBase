---
import type { ImageMetadata } from 'astro';
import { Picture } from 'astro:assets';
import { getCompareComponentDefinition } from '@/lib/component-registry';
import {
  COMPARE_EVENT_NAME,
  type CompareType,
  getCompareLegacyStorageKeys,
  getCompareStorageKey,
} from '@/lib/compare';
import { compareToggleInlineScript } from './compare-toggle-inline-script';

interface Props {
  id: string;
  title: string;
  manufacturer?: string;
  mcu: string;
  mounting?: string;
  uarts?: number;
  can?: number;
  pwm?: number;
  sdCard?: boolean;
  barometer?: boolean;
  ethernet?: boolean;
  firmwares?: string[];
  image?: {
    src: ImageMetadata | string;
    alt?: string;
    credit?: string;
    sourceUrl?: string;
    width?: number;
    height?: number;
  };
  basePath?: string;
  showImage?: boolean;
  variant: 'grid' | 'list';
  class?: string;
  compareId?: string;
  compareType?: CompareType;
  enableCompareToggle?: boolean;
}

const {
  id,
  title,
  manufacturer,
  mcu,
  mounting,
  uarts,
  can,
  pwm,
  sdCard,
  barometer,
  firmwares = [],
  ethernet,
  image,
  basePath = '',
  variant: variantProp = 'grid',
  class: className,
  compareId: compareIdProp,
  compareType: compareTypeProp,
  enableCompareToggle = false,
} = Astro.props;

const componentDefinition = getCompareComponentDefinition('controller');
const defaultCompareType = componentDefinition.id;
const isList = variantProp === 'list';
const compareId = compareIdProp ?? id;
const compareType = compareTypeProp ?? defaultCompareType;
const shouldRenderCompare = enableCompareToggle && Boolean(compareId);
const compareToggleId = shouldRenderCompare
  ? `compare-${compareType}-${compareId}`
  : undefined;
const compareAriaLabel = `Add ${componentDefinition.label.toLowerCase()} to comparison`;

const imageAlt = image?.alt || title;
const localImage =
  image?.src && typeof image.src !== 'string'
    ? (image.src as ImageMetadata)
    : null;
const remoteImage =
  image?.src && typeof image.src === 'string'
    ? { src: image.src, width: image.width ?? 480, height: image.height ?? 320 }
    : null;
const hasImage = Boolean(localImage || remoteImage);
const thumbLetter = (title || '?').charAt(0).toUpperCase();

const mcuDisplay = mcu
  ? mcu.toUpperCase().replace(/^(STMICRO-|ATMEGA-)/, '')
  : 'UNKNOWN';
const mountingDisplay = mounting
  ? mounting === 'cube' || mounting === 'wing' || mounting === 'custom'
    ? mounting.charAt(0).toUpperCase() + mounting.slice(1)
    : mounting.replace('x', '×') + 'mm'
  : undefined;

const firmwareBadges = firmwares.map((fw) => fw.toUpperCase());
const href = `${basePath}/controllers/${id}`;

const ioMetrics = [
  { label: 'UART', value: uarts },
  { label: 'CAN', value: can && can > 0 ? can : undefined },
  { label: 'PWM', value: pwm },
].filter((m) => m.value !== undefined);

const featureFlags = [
  sdCard ? 'SD' : null,
  barometer ? 'Baro' : null,
  ethernet ? 'Eth' : null,
].filter(Boolean) as string[];

const firmwareColorMap: Record<string, string> = {
  ARDUPILOT: 'bg-amber-500/10 text-amber-700 dark:text-amber-400 border-amber-500/20',
  PX4: 'bg-sky-500/10 text-sky-700 dark:text-sky-400 border-sky-500/20',
  INAV: 'bg-emerald-500/10 text-emerald-700 dark:text-emerald-400 border-emerald-500/20',
  BETAFLIGHT: 'bg-violet-500/10 text-violet-700 dark:text-violet-400 border-violet-500/20',
};
const getFirmwareColor = (fw: string) =>
  firmwareColorMap[fw] ?? 'bg-muted/60 text-foreground';

const compareStorageKey = getCompareStorageKey(compareType);
const compareLegacyKeysLiteral = JSON.stringify(
  getCompareLegacyStorageKeys(compareType)
);
const compareToggleScript = compareToggleInlineScript;
---

{isList ? (
  /* ───────────────────── LIST ROW ───────────────────── */
  <article
    class:list={[
      'compare-card group relative transition-colors hover:bg-muted/30',
      className,
    ]}
    data-compare-container={shouldRenderCompare ? compareId : undefined}
    role="listitem"
  >
    <a
      href={href}
      class="absolute inset-0 z-10 focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:ring-inset"
      aria-label={`View ${title}`}
      tabindex="0"
    />

    <div class="grid grid-cols-1 gap-x-4 gap-y-2 px-4 py-3 sm:grid-cols-[minmax(0,2fr)_minmax(0,0.8fr)_minmax(0,1fr)_minmax(0,1fr)_auto] sm:items-center">
      {/* ── Name + Brand ── */}
      <div class="flex items-center gap-3 min-w-0">
        {hasImage && (
          <div class="hidden h-9 w-9 shrink-0 overflow-hidden rounded-md bg-muted/50 ring-1 ring-border sm:block">
            {localImage ? (
              <Picture
                src={localImage}
                widths={[36, 72]}
                formats={['avif', 'webp']}
                sizes="36px"
                alt={imageAlt}
                loading="lazy"
                decoding="async"
                pictureClass="block h-full w-full"
                imgClass="h-full w-full object-cover"
              />
            ) : remoteImage ? (
              <img
                src={remoteImage.src}
                alt={imageAlt}
                width={36}
                height={36}
                loading="lazy"
                decoding="async"
                class="h-full w-full object-cover"
              />
            ) : null}
          </div>
        )}
        <div class="min-w-0 flex-1">
          <div class="text-sm font-semibold text-foreground transition-colors group-hover:text-primary truncate">
            {title}
          </div>
          {manufacturer && (
            <div class="text-xs text-muted-foreground truncate">{manufacturer}</div>
          )}
        </div>
      </div>

      {/* ── MCU + Mounting ── */}
      <div class="hidden sm:flex flex-col gap-0.5">
        <span class="font-mono text-xs font-medium">{mcuDisplay}</span>
        {mountingDisplay && (
          <span class="text-xs text-muted-foreground">{mountingDisplay}</span>
        )}
      </div>

      {/* ── IO + Features ── */}
      <div class="hidden sm:block">
        {ioMetrics.length > 0 && (
          <div class="flex items-center gap-2 text-xs">
            {ioMetrics.map((m) => (
              <span class="tabular-nums">
                <strong class="font-semibold">{m.value}</strong>
                <span class="ml-0.5 text-muted-foreground">{m.label.charAt(0)}</span>
              </span>
            ))}
          </div>
        )}
        {featureFlags.length > 0 && (
          <div class="mt-0.5 flex items-center gap-1.5 text-[11px] text-muted-foreground">
            {featureFlags.map((f) => (
              <span class="inline-flex items-center gap-0.5">
                <span class="text-emerald-600 dark:text-emerald-400">✓</span>{f}
              </span>
            ))}
          </div>
        )}
      </div>

      {/* ── Firmware ── */}
      <div class="hidden sm:flex flex-wrap gap-1">
        {firmwareBadges.map((label) => (
          <span
            class:list={[
              'inline-flex items-center rounded-sm border px-1.5 py-0.5 text-[10px] font-semibold uppercase tracking-wide',
              getFirmwareColor(label),
            ]}
          >
            {label}
          </span>
        ))}
      </div>

      {/* ── Actions ── */}
      <div class="hidden sm:flex items-center gap-2 justify-end">
        {shouldRenderCompare && compareToggleId && (
          <div
            class="compare-toggle relative z-20 flex items-center gap-1 text-[10px] text-muted-foreground"
            data-compare-toggle-wrapper
          >
            <input
              id={compareToggleId}
              type="checkbox"
              class="h-3 w-3 rounded-sm border text-primary focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-primary/40"
              data-compare-toggle={compareId}
              data-compare-type={compareType}
              aria-label={compareAriaLabel}
            />
            <label
              for={compareToggleId}
              class="font-semibold uppercase tracking-wide cursor-pointer"
            >
              Cmp
            </label>
          </div>
        )}
        <span
          class="text-sm text-muted-foreground/60 transition-colors group-hover:text-primary"
          aria-hidden="true"
        >
          →
        </span>
      </div>

      {/* ── Mobile condensed row ── */}
      <div class="flex flex-wrap items-center gap-2 text-xs sm:hidden">
        <span class="font-mono font-medium">{mcuDisplay}</span>
        {mountingDisplay && (
          <span class="text-muted-foreground">· {mountingDisplay}</span>
        )}
        {ioMetrics.length > 0 &&
          ioMetrics.map((m) => (
            <span class="tabular-nums text-muted-foreground">
              {m.value}{m.label.charAt(0)}
            </span>
          ))}
        {firmwareBadges.length > 0 && (
          <span class="text-muted-foreground">
            · {firmwareBadges.join(' · ')}
          </span>
        )}
      </div>
    </div>

    {shouldRenderCompare && (
      <script
        is:inline
        data-compare-id={compareId}
        data-compare-type={compareType}
        data-compare-storage-key={compareStorageKey}
        data-compare-event-name={COMPARE_EVENT_NAME}
        data-compare-legacy-keys={compareLegacyKeysLiteral}
        set:html={compareToggleScript}
      />
    )}
  </article>
) : (
  /* ───────────────────── GRID CARD ───────────────────── */
  <article
    class:list={[
      'compare-card group relative flex flex-col overflow-hidden rounded-lg border bg-card transition-all hover:border-primary/30 hover:shadow-sm',
      className,
    ]}
    data-compare-container={shouldRenderCompare ? compareId : undefined}
  >
    {/* Full-card click target */}
    <a
      href={href}
      class="absolute inset-0 z-10 rounded-lg focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-primary/40"
      aria-label={`View ${title}`}
      tabindex="0"
    />

    {/* 1 ── Header: Thumbnail + Title ── */}
    <div class="flex items-start gap-3 p-3">
      <div class="flex h-11 w-11 shrink-0 items-center justify-center overflow-hidden rounded-md bg-muted/50 ring-1 ring-border">
        {localImage ? (
          <Picture
            src={localImage}
            widths={[48, 96]}
            formats={['avif', 'webp']}
            sizes="48px"
            alt={imageAlt}
            loading="lazy"
            decoding="async"
            pictureClass="block h-full w-full"
            imgClass="h-full w-full object-cover"
          />
        ) : remoteImage ? (
          <img
            src={remoteImage.src}
            alt={imageAlt}
            width={48}
            height={48}
            loading="lazy"
            decoding="async"
            class="h-full w-full object-cover"
          />
        ) : (
          <span class="text-sm font-bold text-muted-foreground">
            {thumbLetter}
          </span>
        )}
      </div>
      <div class="min-w-0 flex-1">
        <h3 class="text-sm font-semibold leading-snug text-foreground transition-colors group-hover:text-primary truncate">
          {title}
        </h3>
        {manufacturer && (
          <p class="mt-0.5 text-xs text-muted-foreground truncate">
            {manufacturer}
          </p>
        )}
      </div>
    </div>

    {/* 2 ── Specs: MCU + Mounting ── */}
    <div class="flex items-center gap-1.5 border-t px-3 py-2">
      <span class="inline-flex items-center rounded bg-muted/60 px-1.5 py-0.5 font-mono text-[11px] font-medium">
        {mcuDisplay}
      </span>
      {mountingDisplay && (
        <span class="inline-flex items-center rounded bg-muted/60 px-1.5 py-0.5 text-[11px] font-medium">
          {mountingDisplay}
        </span>
      )}
    </div>

    {/* 3 ── IO Metrics + Feature flags ── */}
    <div class="flex items-end justify-between gap-2 border-t px-3 py-2">
      {ioMetrics.length > 0 ? (
        <div class="flex items-end gap-4">
          {ioMetrics.map((metric) => (
            <div class="leading-none">
              <div class="text-lg font-bold tabular-nums text-foreground">
                {metric.value}
              </div>
              <div class="mt-0.5 text-[9px] font-semibold uppercase tracking-wider text-muted-foreground">
                {metric.label}
              </div>
            </div>
          ))}
        </div>
      ) : (
        <span class="text-xs text-muted-foreground">No IO data</span>
      )}
      {featureFlags.length > 0 && (
        <div class="flex flex-col items-end gap-0.5">
          {featureFlags.map((flag) => (
            <span class="inline-flex items-center gap-1 text-[11px] text-muted-foreground">
              <svg
                class="h-3 w-3 text-emerald-600 dark:text-emerald-400"
                viewBox="0 0 16 16"
                fill="currentColor"
              >
                <path d="M12.416 3.376a.75.75 0 0 1 .208 1.04l-5 7.5a.75.75 0 0 1-1.154.114l-3-3a.75.75 0 0 1 1.06-1.06l2.353 2.353 4.493-6.74a.75.75 0 0 1 1.04-.207Z" />
              </svg>
              {flag}
            </span>
          ))}
        </div>
      )}
    </div>

    {/* 4 ── Firmware badges ── */}
    {firmwareBadges.length > 0 && (
      <div class="mt-auto flex flex-wrap gap-1 border-t px-3 py-2">
        {firmwareBadges.map((label) => (
          <span
            class:list={[
              'inline-flex items-center rounded-sm border px-1.5 py-0.5 text-[10px] font-semibold uppercase tracking-wide',
              getFirmwareColor(label),
            ]}
          >
            {label}
          </span>
        ))}
      </div>
    )}

    {/* Compare toggle */}
    {shouldRenderCompare && compareToggleId && (
      <div
        class="compare-toggle absolute right-2 top-2 z-20 flex items-center gap-1 rounded-full border bg-background/90 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-muted-foreground shadow-xs backdrop-blur"
        data-compare-toggle-wrapper
      >
        <input
          id={compareToggleId}
          type="checkbox"
          class="h-3 w-3 rounded-sm border text-primary focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-primary/40"
          data-compare-toggle={compareId}
          data-compare-type={compareType}
          aria-label={compareAriaLabel}
        />
        <label for={compareToggleId} class="cursor-pointer">Compare</label>
      </div>
    )}

    {shouldRenderCompare && (
      <script
        is:inline
        data-compare-id={compareId}
        data-compare-type={compareType}
        data-compare-storage-key={compareStorageKey}
        data-compare-event-name={COMPARE_EVENT_NAME}
        data-compare-legacy-keys={compareLegacyKeysLiteral}
        set:html={compareToggleScript}
      />
    )}
  </article>
)}
