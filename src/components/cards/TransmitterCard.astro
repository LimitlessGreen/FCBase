---
import type { ImageMetadata } from 'astro';
import { Picture } from 'astro:assets';
import { getCompareComponentDefinition } from '@/lib/component-registry';
import {
  COMPARE_EVENT_NAME,
  type CompareType,
  getCompareLegacyStorageKeys,
  getCompareStorageKey,
} from '@/lib/compare';
import { compareToggleInlineScript } from './compare-toggle-inline-script';

type SupportLevel = 'official' | 'manufacturer' | 'community';
type SupportStatus = 'supported' | 'limited' | 'sunset' | 'planned';

interface SupportMeta {
  level: SupportLevel;
  status: SupportStatus;
  sinceVersion: string;
  lastVersion?: string;
  notes?: string;
}

interface HardwareRevision {
  id: string;
  name: string;
}

interface ComplianceEntry {
  id: string;
  type?: string;
  url?: string | null;
}

interface Props {
  id: string;
  slug: string;
  title: string;
  manufacturer?: string;
  support: SupportMeta;
  hardwareRevisions?: HardwareRevision[];
  compliance?: ComplianceEntry[];
  image?: {
    src: ImageMetadata | string;
    alt?: string;
    credit?: string;
    sourceUrl?: string;
    width?: number;
    height?: number;
  };
  basePath?: string;
  showImage?: boolean;
  variant: 'grid' | 'list';
  remoteUrl?: string;
  class?: string;
  compareId?: string;
  compareType?: CompareType;
  enableCompareToggle?: boolean;
}

const {
  id,
  slug,
  title,
  manufacturer,
  support,
  hardwareRevisions = [],
  compliance = [],
  image,
  basePath = '',
  variant: variantProp = 'grid',
  remoteUrl,
  class: className,
  compareId: compareIdProp,
  compareType: compareTypeProp,
  enableCompareToggle = false,
} = Astro.props;

const componentDefinition = getCompareComponentDefinition('transmitter');
const defaultCompareType = componentDefinition.id;
const isList = variantProp === 'list';
const compareId = compareIdProp ?? id;
const compareType = compareTypeProp ?? defaultCompareType;
const shouldRenderCompare = enableCompareToggle && Boolean(compareId);
const compareToggleId = shouldRenderCompare
  ? `compare-${compareType}-${compareId}`
  : undefined;
const compareAriaLabel = `Add ${componentDefinition.label.toLowerCase()} to comparison`;

const imageAlt = image?.alt || title;
const localImage =
  image?.src && typeof image.src !== 'string'
    ? (image.src as ImageMetadata)
    : null;
const remoteImage =
  image?.src && typeof image.src === 'string'
    ? { src: image.src, width: image.width ?? 480, height: image.height ?? 320 }
    : null;
const hasImage = Boolean(localImage || remoteImage);
const thumbLetter = (title || '?').charAt(0).toUpperCase();

const targetSlug = slug || id;
const href = `${basePath}/transmitters/${targetSlug}`;

const revisionCount = hardwareRevisions.length;
const complianceCount = compliance.length;
const supportNotes = support.notes?.trim();
const hasRemoteLink = Boolean(remoteUrl);

/* ── Compact labels for card context ── */
const compactLevelLabels: Record<SupportLevel, string> = {
  official: 'Official',
  manufacturer: 'Manufacturer',
  community: 'Community',
};
const compactStatusLabels: Record<SupportStatus, string> = {
  supported: 'Supported',
  limited: 'Limited',
  sunset: 'Sunset',
  planned: 'Planned',
};

/* ── Color coding ── */
const levelColorMap: Record<SupportLevel, string> = {
  official:
    'bg-emerald-500/10 text-emerald-700 dark:text-emerald-400 border-emerald-500/20',
  manufacturer:
    'bg-blue-500/10 text-blue-700 dark:text-blue-400 border-blue-500/20',
  community:
    'bg-amber-500/10 text-amber-700 dark:text-amber-400 border-amber-500/20',
};
const statusColorMap: Record<SupportStatus, string> = {
  supported:
    'bg-emerald-500/10 text-emerald-700 dark:text-emerald-400 border-emerald-500/20',
  limited:
    'bg-yellow-500/10 text-yellow-700 dark:text-yellow-400 border-yellow-500/20',
  sunset:
    'bg-red-500/10 text-red-700 dark:text-red-400 border-red-500/20',
  planned:
    'bg-sky-500/10 text-sky-700 dark:text-sky-400 border-sky-500/20',
};

const levelLabel = compactLevelLabels[support.level];
const statusLabel = compactStatusLabels[support.status];
const levelColor = levelColorMap[support.level] ?? '';
const statusColor = statusColorMap[support.status] ?? '';

const hasDetails = revisionCount > 0 || complianceCount > 0;

const compareStorageKey = getCompareStorageKey(compareType);
const compareLegacyKeysLiteral = JSON.stringify(
  getCompareLegacyStorageKeys(compareType)
);
const compareToggleScript = compareToggleInlineScript;
---

{isList ? (
  /* ───────────────────── LIST ROW ───────────────────── */
  <article
    class:list={[
      'compare-card group relative transition-colors hover:bg-muted/30',
      className,
    ]}
    data-compare-container={shouldRenderCompare ? compareId : undefined}
    role="listitem"
  >
    <a
      href={href}
      class="absolute inset-0 z-10 focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-primary/40 focus-visible:ring-inset"
      aria-label={`View ${title}`}
      tabindex="0"
    />

    <div class="grid grid-cols-1 gap-x-3 gap-y-1 px-3 py-1.5 sm:grid-cols-[minmax(0,2fr)_minmax(0,1fr)_minmax(0,0.8fr)_minmax(0,0.8fr)_auto] sm:items-center">
      {/* ── Name + Brand ── */}
      <div class="flex items-center gap-3 min-w-0">
        {hasImage && (
          <div class="hidden h-16 w-16 shrink-0 overflow-hidden rounded-md bg-muted/50 ring-1 ring-border sm:block">
            {localImage ? (
              <Picture
                src={localImage}
                widths={[64, 128]}
                formats={['avif', 'webp']}
                sizes="64px"
                alt={imageAlt}
                loading="lazy"
                decoding="async"
                pictureClass="block h-full w-full"
                imgClass="h-full w-full object-cover"
              />
            ) : remoteImage ? (
              <img
                src={remoteImage.src}
                alt={imageAlt}
                width={64}
                height={64}
                loading="lazy"
                decoding="async"
                class="h-full w-full object-cover"
              />
            ) : null}
          </div>
        )}
        <div class="min-w-0 flex-1">
          <div class="text-sm font-semibold text-foreground transition-colors group-hover:text-primary truncate">
            {title}
          </div>
          {manufacturer && (
            <div class="text-xs text-muted-foreground truncate">{manufacturer}</div>
          )}
        </div>
      </div>

      {/* ── Support badges ── */}
      <div class="hidden sm:flex flex-wrap gap-1">
        <span
          class:list={[
            'inline-flex items-center rounded-sm border px-1.5 py-0.5 text-[10px] font-semibold uppercase tracking-wide',
            levelColor,
          ]}
        >
          {levelLabel}
        </span>
        <span
          class:list={[
            'inline-flex items-center rounded-sm border px-1.5 py-0.5 text-[10px] font-semibold uppercase tracking-wide',
            statusColor,
          ]}
        >
          {statusLabel}
        </span>
      </div>

      {/* ── Timeline ── */}
      <div class="hidden sm:block text-xs">
        <div>
          Since <strong class="font-semibold">{support.sinceVersion}</strong>
        </div>
        {support.lastVersion && (
          <div class="text-muted-foreground">Last {support.lastVersion}</div>
        )}
      </div>

      {/* ── Details ── */}
      <div class="hidden sm:block text-xs text-muted-foreground">
        {revisionCount > 0 && <div>{revisionCount} Hardware revs</div>}
        {complianceCount > 0 && <div>{complianceCount} Compliance</div>}
      </div>

      {/* ── Actions ── */}
      <div class="hidden sm:flex items-center gap-2 justify-end">
        {hasRemoteLink && (
          <a
            href={remoteUrl}
            target="_blank"
            rel="noopener noreferrer"
            class="relative z-20 text-[10px] font-semibold uppercase tracking-wide text-muted-foreground transition-colors hover:text-primary"
          >
            View YAML ↗
          </a>
        )}
        {shouldRenderCompare && compareToggleId && (
          <div
            class="compare-toggle relative z-20 flex items-center gap-1 text-[10px] text-muted-foreground"
            data-compare-toggle-wrapper
          >
            <input
              id={compareToggleId}
              type="checkbox"
              class="h-3 w-3 rounded-sm border text-primary focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-primary/40"
              data-compare-toggle={compareId}
              data-compare-type={compareType}
              aria-label={compareAriaLabel}
            />
            <label
              for={compareToggleId}
              class="font-semibold uppercase tracking-wide cursor-pointer"
            >
              Compare
            </label>
          </div>
        )}
        <span
          class="text-sm text-muted-foreground/60 transition-colors group-hover:text-primary"
          aria-hidden="true"
        >
          →
        </span>
      </div>

      {/* ── Mobile condensed ── */}
      <div class="flex flex-wrap items-center gap-2 text-xs sm:hidden">
        <span
          class:list={[
            'inline-flex items-center rounded-sm border px-1 py-0.5 text-[10px] font-semibold uppercase',
            levelColor,
          ]}
        >
          {levelLabel}
        </span>
        <span
          class:list={[
            'inline-flex items-center rounded-sm border px-1 py-0.5 text-[10px] font-semibold uppercase',
            statusColor,
          ]}
        >
          {statusLabel}
        </span>
        <span class="text-muted-foreground">
          · Since {support.sinceVersion}
        </span>
      </div>
    </div>

    {shouldRenderCompare && (
      <script
        is:inline
        data-compare-id={compareId}
        data-compare-type={compareType}
        data-compare-storage-key={compareStorageKey}
        data-compare-event-name={COMPARE_EVENT_NAME}
        data-compare-legacy-keys={compareLegacyKeysLiteral}
        set:html={compareToggleScript}
      />
    )}
  </article>
) : (
  /* ───────────────────── GRID CARD ───────────────────── */
  <article
    class:list={[
      'compare-card group relative flex flex-col overflow-hidden rounded-lg border bg-card transition-all hover:border-primary/30 hover:shadow-sm',
      className,
    ]}
    data-compare-container={shouldRenderCompare ? compareId : undefined}
  >
    {/* Full-card click target */}
    <a
      href={href}
      class="absolute inset-0 z-10 rounded-lg focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-primary/40"
      aria-label={`View ${title}`}
      tabindex="0"
    />

    {/* 1 ── Header: Thumbnail + Title ── */}
    <div class="flex items-start gap-3 p-3">
      <div class="flex h-16 w-16 shrink-0 items-center justify-center overflow-hidden rounded-md bg-muted/50 ring-1 ring-border">
        {localImage ? (
          <Picture
            src={localImage}
            widths={[64, 128]}
            formats={['avif', 'webp']}
            sizes="64px"
            alt={imageAlt}
            loading="lazy"
            decoding="async"
            pictureClass="block h-full w-full"
            imgClass="h-full w-full object-cover"
          />
        ) : remoteImage ? (
          <img
            src={remoteImage.src}
            alt={imageAlt}
            width={64}
            height={64}
            loading="lazy"
            decoding="async"
            class="h-full w-full object-cover"
          />
        ) : (
          <span class="text-sm font-bold text-muted-foreground">
            {thumbLetter}
          </span>
        )}
      </div>
      <div class="min-w-0 flex-1">
        <h3 class="text-sm font-semibold leading-snug text-foreground transition-colors group-hover:text-primary truncate">
          {title}
        </h3>
        {manufacturer && (
          <p class="mt-0.5 text-xs text-muted-foreground truncate">
            {manufacturer}
          </p>
        )}
      </div>
    </div>

    {/* 2 ── Support badges ── */}
    <div class="flex items-center gap-1.5 border-t px-3 py-2">
      <span
        class:list={[
          'inline-flex items-center rounded-sm border px-1.5 py-0.5 text-[10px] font-semibold uppercase tracking-wide',
          levelColor,
        ]}
      >
        {levelLabel}
      </span>
      <span
        class:list={[
          'inline-flex items-center rounded-sm border px-1.5 py-0.5 text-[10px] font-semibold uppercase tracking-wide',
          statusColor,
        ]}
      >
        {statusLabel}
      </span>
    </div>

    {/* 3 ── Version timeline ── */}
    <div class="flex items-end gap-4 border-t px-3 py-2">
      <div class="leading-none">
        <div class="text-base font-bold text-foreground">{support.sinceVersion}</div>
        <div class="mt-0.5 text-[9px] font-semibold uppercase tracking-wider text-muted-foreground">
          Since
        </div>
      </div>
      {support.lastVersion && (
        <div class="leading-none">
          <div class="text-base font-bold text-foreground">
            {support.lastVersion}
          </div>
          <div class="mt-0.5 text-[9px] font-semibold uppercase tracking-wider text-muted-foreground">
            Latest
          </div>
        </div>
      )}
    </div>

    {/* 4 ── Footer: details + notes ── */}
    <div class="mt-auto border-t px-3 py-2 text-xs text-muted-foreground">
      {hasDetails ? (
        <div class="flex flex-wrap items-center gap-x-3 gap-y-0.5">
          {revisionCount > 0 && (
            <span>{revisionCount} hardware variant{revisionCount > 1 ? 's' : ''}</span>
          )}
          {complianceCount > 0 && (
            <span>{complianceCount} compliance ID{complianceCount > 1 ? 's' : ''}</span>
          )}
        </div>
      ) : supportNotes ? (
        <p class="line-clamp-2 leading-snug">{supportNotes}</p>
      ) : (
        <span class="text-muted-foreground/60">View profile for details →</span>
      )}
    </div>

    {/* Notes (shown separately if there are also details) */}
    {hasDetails && supportNotes && (
      <div class="border-t px-3 py-2">
        <p class="text-xs text-muted-foreground line-clamp-2 leading-snug">
          {supportNotes}
        </p>
      </div>
    )}

    {/* YAML link */}
    {hasRemoteLink && (
      <div class="border-t px-3 py-1.5">
        <a
          href={remoteUrl}
          target="_blank"
          rel="noopener noreferrer"
          class="relative z-20 inline-flex items-center gap-1 text-[10px] font-semibold uppercase tracking-wide text-muted-foreground transition-colors hover:text-primary"
        >
          View YAML ↗
        </a>
      </div>
    )}

    {/* Compare toggle */}
    {shouldRenderCompare && compareToggleId && (
      <div
        class="compare-toggle absolute right-2 top-2 z-20 flex items-center gap-1 rounded-full border bg-background/90 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-muted-foreground shadow-xs backdrop-blur"
        data-compare-toggle-wrapper
      >
        <input
          id={compareToggleId}
          type="checkbox"
          class="h-3 w-3 rounded-sm border text-primary focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-primary/40"
          data-compare-toggle={compareId}
          data-compare-type={compareType}
          aria-label={compareAriaLabel}
        />
        <label for={compareToggleId} class="cursor-pointer">Compare</label>
      </div>
    )}

    {shouldRenderCompare && (
      <script
        is:inline
        data-compare-id={compareId}
        data-compare-type={compareType}
        data-compare-storage-key={compareStorageKey}
        data-compare-event-name={COMPARE_EVENT_NAME}
        data-compare-legacy-keys={compareLegacyKeysLiteral}
        set:html={compareToggleScript}
      />
    )}
  </article>
)}
