---
import { getCollection } from 'astro:content';
import MainLayout from '@/layouts/MainLayout.astro';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/Card';
import { Badge } from '@/components/ui/Badge';
import { getBasePath } from '@/lib/paths';

// Load all sensors
const allSensors = await getCollection('sensors');
const controllers = await getCollection('controllers');

const sensorUsageCounts = controllers.reduce((acc, controller) => {
  const { sensors } = controller.data;
  if (!sensors) return acc;

  Object.values(sensors).forEach((group) => {
    group?.forEach((entry) => {
      const sensorId = typeof entry === 'string' ? entry : entry?.id;
      if (!sensorId) return;
      acc[sensorId] = (acc[sensorId] ?? 0) + 1;
    });
  });

  return acc;
}, {} as Record<string, number>);

// Group by type
const sensorsByType = allSensors.reduce((acc, sensor) => {
  const type = sensor.data.type || 'other';
  if (!acc[type]) acc[type] = [];
  acc[type].push(sensor);
  return acc;
}, {} as Record<string, typeof allSensors>);

// Sort each group by name
Object.keys(sensorsByType).forEach((type) => {
  sensorsByType[type].sort((a, b) => (a.data.name || a.data.title || a.id).localeCompare(b.data.name || b.data.title || b.id));
});

const typeDisplay: Record<string, string> = {
  imu: 'IMU (Gyro/Accel)',
  barometer: 'Barometer',
  magnetometer: 'Magnetometer',
  gps: 'GPS',
  other: 'Other',
};

const basePath = getBasePath();
---

<MainLayout
  title="Sensors - FCBase"
  description="Browse flight controller sensors. Find IMU, barometer, magnetometer, and GPS specs used in flight controllers."
  editPath="src/pages/sensors/index.astro"
>
    <div class="container py-8">
      <!-- Header -->
      <div class="mb-8">
        <nav class="mb-4 flex items-center gap-2 text-sm text-muted-foreground">
          <a href={`${basePath}/`} class="hover:text-foreground transition-colors">Home</a>
          <span>/</span>
          <span class="text-foreground">Sensors</span>
        </nav>
        
        <h1 class="text-4xl font-bold tracking-tight mb-3">Sensors</h1>
        <p class="text-lg text-muted-foreground">
          Browse {allSensors.length} flight controller sensors by type
        </p>
      </div>

      <!-- Sensors by Type -->
      {Object.entries(sensorsByType).map(([type, sensors]) => (
        <div class="mb-12">
          <h2 class="text-2xl font-bold tracking-tight mb-4 flex items-center gap-3">
            {typeDisplay[type] || type}
            <Badge variant="secondary" className="text-sm">
              {sensors.length}
            </Badge>
          </h2>
          <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            {sensors.map((sensor) => (
              <a
                href={`${basePath}/sensors/${sensor.id}`}
                class="group block"
              >
                <Card class="h-full transition-all hover:shadow-lg hover:-translate-y-1">
                  <CardHeader>
                    <CardTitle className="text-base group-hover:text-primary transition-colors line-clamp-2">
                      {sensor.data.name || sensor.data.title || sensor.id}
                    </CardTitle>
                    {sensor.data.manufacturer && (
                      <CardDescription className="text-xs">
                        {sensor.data.manufacturer}
                      </CardDescription>
                    )}
                  </CardHeader>
                  <CardContent>
                    <div class="flex flex-wrap gap-1.5">
                      <Badge variant="outline" className="text-xs capitalize">
                        {type}
                      </Badge>
                      {sensor.data.interface && (
                        <Badge variant="secondary" className="text-xs uppercase">
                          {Array.isArray(sensor.data.interface) ? sensor.data.interface.join('/') : sensor.data.interface}
                        </Badge>
                      )}
                      {sensor.data.axes && (
                        <Badge variant="secondary" className="text-xs">
                          {sensor.data.axes}-axis
                        </Badge>
                      )}
                    </div>
                    <p class="mt-3 text-xs text-muted-foreground">
                      {(() => {
                        const usageCount = sensorUsageCounts[sensor.data.id || sensor.id] ?? 0;
                        return `Used in ${usageCount} flight controller${usageCount === 1 ? '' : 's'}`;
                      })()}
                    </p>
                  </CardContent>
                </Card>
              </a>
            ))}
          </div>
        </div>
      ))}

      {/* Empty State */}
      {allSensors.length === 0 && (
        <div class="text-center py-12">
          <p class="text-muted-foreground">No sensors found.</p>
        </div>
      )}
    </div>
</MainLayout>
