---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import MainLayout from '@/layouts/MainLayout.astro';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/Card';
import ProfessionalTable from '@/components/table/ProfessionalTable.astro';
import TableRow2Col from '@/components/table/TableRow2Col.astro';
import TableRow from '@/components/table/TableRow.astro';
import ControllerCard from '@/components/cards/ControllerCard.astro';
import { Badge } from '@/components/ui/Badge';
import { AlertTriangle, ExternalLink } from 'lucide-react';
import { createControllerCardModel } from '@/lib/controller-card-model';
import { getManufacturersMap, getSourcesMap } from '@/lib/content-cache';

export async function getStaticPaths() {
  const sensors = await getCollection('sensors');
  return sensors.map((sensor) => ({
    params: { slug: sensor.id },
    props: { sensor },
  }));
}

const { sensor } = Astro.props;
const { data } = sensor;

// Load all controllers using this sensor
const allControllers = await getCollection('controllers');
const manufacturersMap = await getManufacturersMap();
const sourcesMap = await getSourcesMap();

const controllersUsingSensor = allControllers.filter((controller) => {
  const sensors = controller.data.sensors;
  if (!sensors) return false;

  return Object.values(sensors).some((sensorGroup) =>
    Array.isArray(sensorGroup) && sensorGroup.some((s) => s.id === sensor.id)
  );
});

const controllersGroupedByBrandEntries = Array.from(
  controllersUsingSensor.reduce((accumulator, controller) => {
    const brandId = controller.data.brand || 'unknown';
    const existingGroup = accumulator.get(brandId) ?? [];

    existingGroup.push(controller);
    accumulator.set(brandId, existingGroup);

    return accumulator;
  }, new Map<string, typeof controllersUsingSensor>())
);

const controllersGroupedByBrand = await Promise.all(
  controllersGroupedByBrandEntries.map(async ([brandId, controllers]) => {
    const brandEntry = manufacturersMap.get(brandId);
    const brandName = brandEntry?.data?.name || brandEntry?.data?.title || brandId;

    const sortedControllers = [...controllers].sort((a, b) =>
      a.data.title.localeCompare(b.data.title)
    );

    const controllerCards = await Promise.all(
      sortedControllers.map((controller) =>
        createControllerCardModel(controller, { manufacturersMap })
      )
    );

    return { brandName, controllers: controllerCards };
  })
);

controllersGroupedByBrand.sort((a, b) => a.brandName.localeCompare(b.brandName));

const typeDisplay: Record<string, string> = {
  imu: 'IMU (Gyro/Accel)',
  barometer: 'Barometer',
  magnetometer: 'Magnetometer',
  gps: 'GPS',
};

const basePath = import.meta.env.BASE_URL.replace(/\/$/, '');
const editPath = `src/content/sensors/${sensor.id}.yaml`;
const sensorTitle = data.name || data.title || sensor.id;
const canonicalUrl = Astro.site
  ? new URL(`sensors/${sensor.id}`, Astro.site).toString()
  : `${basePath}/sensors/${sensor.id}`;
const sensorSummary = data.summary || data.notes || `Technical specification for the ${sensorTitle} sensor used in FCBase controllers.`;

const severityStyles = {
  info: { label: 'Info', className: 'bg-sky-500/10 text-sky-600 border-sky-500/20' },
  low: { label: 'Low', className: 'bg-emerald-500/10 text-emerald-600 border-emerald-500/30' },
  medium: { label: 'Medium', className: 'bg-amber-500/10 text-amber-600 border-amber-500/30' },
  high: { label: 'High', className: 'bg-rose-500/10 text-rose-500 border-rose-500/30' },
  critical: { label: 'Critical', className: 'bg-red-600/10 text-red-600 border-red-600/30' },
} as const;

const knownIssues = (data.known_issues ?? [])
  .map((issue) => {
    const severityKey = issue.severity in severityStyles ? issue.severity : 'medium';
    const severityMeta = severityStyles[severityKey as keyof typeof severityStyles];
    const sourceEntry = sourcesMap.get(issue.source) ?? null;
    const sourceTitle = sourceEntry?.data.title ?? issue.source;
    const sourceUrl = issue.url ?? sourceEntry?.data.url ?? null;
    let displayDate: string | null = null;
    if (issue.date) {
      const parsed = new Date(issue.date);
      displayDate = Number.isNaN(parsed.valueOf())
        ? issue.date
        : parsed.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
          });
    }

    return {
      ...issue,
      severityKey,
      severityMeta,
      sourceTitle,
      sourceUrl,
      displayDate,
    };
  })
  .sort((a, b) => (a.date > b.date ? -1 : a.date < b.date ? 1 : 0));

const hasKnownIssues = knownIssues.length > 0;
---

<BaseLayout
  title={`${data.name || data.title || sensor.id} - Sensors - FCBase`}
  description={`${data.name || data.title} sensor. ${data.manufacturer ? `Manufactured by ${data.manufacturer}.` : ''} ${data.notes || ''}`}
>
  <Fragment slot="head">
    <link rel="canonical" href={canonicalUrl} />
    <meta name="pagefind:meta:id" content={sensor.id} />
    <meta name="pagefind:meta:type" content="sensor" />
    <meta name="pagefind:filter:type" content="sensor" />
    <meta name="pagefind:meta:title" content={sensorTitle} />
    {data.manufacturer && <meta name="pagefind:meta:manufacturer" content={data.manufacturer} />}
    {data.type && <meta name="pagefind:meta:sensor_type" content={data.type} />}
    <meta name="pagefind:meta:summary" content={sensorSummary} />
    <meta name="pagefind:meta:url" content={canonicalUrl} />
  </Fragment>
  <MainLayout editPath={editPath} showEditBar>
    <div class="container py-8">
      <!-- Breadcrumb -->
      <nav class="mb-6 flex items-center gap-2 text-sm text-muted-foreground">
        <a href={`${basePath}/`} class="hover:text-foreground transition-colors">Home</a>
        <span>/</span>
        <a href={`${basePath}/sensors`} class="hover:text-foreground transition-colors">Sensors</a>
        <span>/</span>
        <span class="text-foreground">{data.name || data.title || sensor.id}</span>
      </nav>

      <!-- Header -->
      <div class="mb-6">
        <h1 class="text-3xl font-bold tracking-tight mb-1">{data.name || data.title || sensor.id}</h1>
        {data.manufacturer && (
          <p class="text-base text-muted-foreground mb-2">
            by {data.manufacturer}
          </p>
        )}
        {data.notes && (
          <p class="text-sm text-muted-foreground">{data.notes}</p>
        )}
      </div>

      <!-- Professional Specs Card -->
      <div class="mb-6">
        <Card>
          <CardHeader>
            <h2 class="text-base font-bold uppercase tracking-wide text-primary">Technical Specifications</h2>
          </CardHeader>
          <CardContent class="pt-0">
            <ProfessionalTable>
              <TableRow2Col
                label1="Type"
                value1={typeDisplay[data.type] || data.type}
                label2="Interface"
                value2={Array.isArray(data.interface) ? data.interface.join(' / ') : data.interface}
                mono2
              />
              
              <TableRow2Col
                label1={data.axes ? "Axes" : " "}
                value1={data.axes ? `${data.axes}-axis` : ""}
                label2="Used in Controllers"
                value2={controllersUsingSensor.length}
                mono1={!!data.axes}
              />
              
              {data.datasheet?.url && (
                <TableRow label="Datasheet">
                  <a
                    href={data.datasheet.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-flex items-center gap-1.5 text-primary hover:underline font-semibold text-sm"
                  >
                    <ExternalLink className="h-4 w-4" />
                    <span>PDF</span>
                    {data.datasheet.year && <span class="text-xs text-muted-foreground font-normal">({data.datasheet.year})</span>}
                  </a>
                </TableRow>
              )}
            </ProfessionalTable>
          </CardContent>
        </Card>
      </div>

      <!-- Known Issues -->
      <div class="mb-6">
        <h2 class="text-xl font-bold tracking-tight mb-4 uppercase text-primary">Known Issues</h2>
        {hasKnownIssues ? (
          <div class="space-y-4">
            {knownIssues.map((issue, index) => (
              <Card
                key={issue.id ?? `${issue.date}-${issue.title}-${index}`}
                className="border border-border/60 bg-background/80 shadow-xs"
              >
                <CardHeader className="flex flex-col gap-3 border-b border-border/40 pb-4 sm:flex-row sm:items-start sm:justify-between">
                  <div class="flex items-start gap-3">
                    <span class="mt-1 inline-flex h-8 w-8 items-center justify-center rounded-full bg-amber-500/10 text-amber-500">
                      <AlertTriangle className="h-4 w-4" />
                    </span>
                    <div class="space-y-1">
                      <CardTitle className="text-base leading-tight">{issue.title}</CardTitle>
                      {issue.description && (
                        <CardDescription className="text-sm leading-snug text-muted-foreground">
                          {issue.description}
                        </CardDescription>
                      )}
                    </div>
                  </div>
                  <Badge
                    variant="outline"
                    className={`text-[10px] uppercase tracking-wide ${issue.severityMeta.className}`}
                  >
                    {issue.severityMeta.label}
                  </Badge>
                </CardHeader>
                <CardContent className="flex flex-col gap-3 pt-4 text-sm text-muted-foreground sm:flex-row sm:items-center sm:justify-between">
                  <div class="flex items-center gap-2 text-xs uppercase tracking-wide text-muted-foreground">
                    <span class="font-semibold text-foreground">Reported</span>
                    {issue.displayDate ? (
                      <time dateTime={issue.date} class="font-mono text-foreground">
                        {issue.displayDate}
                      </time>
                    ) : (
                      <span class="font-mono text-foreground">{issue.date}</span>
                    )}
                  </div>
                  <div class="flex items-center gap-2 text-xs uppercase tracking-wide text-muted-foreground">
                    <span class="font-semibold text-foreground">Source</span>
                    {issue.sourceUrl ? (
                      <a
                        href={issue.sourceUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="inline-flex items-center gap-1 font-semibold text-primary transition hover:text-primary/80"
                      >
                        {issue.sourceTitle}
                        <ExternalLink className="h-3.5 w-3.5" />
                      </a>
                    ) : (
                      <span class="font-semibold text-foreground">{issue.sourceTitle}</span>
                    )}
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        ) : (
          <Card className="border border-dashed border-border/60 bg-muted/20">
            <CardHeader>
              <CardTitle className="text-base font-semibold">No documented issues</CardTitle>
              <CardDescription>
                We have not recorded any open advisories for this sensor yet.
              </CardDescription>
            </CardHeader>
            <CardContent className="text-sm text-muted-foreground">
              Notice abnormal behavior? Share reproducible reports so we can update the community database.
            </CardContent>
          </Card>
        )}
      </div>

      <!-- Controllers Using This Sensor -->
      {controllersUsingSensor.length > 0 ? (
        <>
          <h2 class="text-xl font-bold tracking-tight mb-4 uppercase text-primary">Controllers Using This Sensor</h2>
          <div class="space-y-6">
            {controllersGroupedByBrand.map(({ brandName, controllers }) => (
              <section class="space-y-3">
                <h3 class="text-sm font-semibold uppercase tracking-wide text-muted-foreground">
                  {brandName}
                </h3>
                <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
                  {controllers.map((controller) => (
                    <ControllerCard
                      key={controller.id}
                      id={controller.id}
                      title={controller.title}
                      manufacturer={controller.manufacturer || brandName}
                      mcu={controller.mcu}
                      mounting={controller.mounting}
                      uarts={controller.uarts}
                      can={controller.can}
                      pwm={controller.pwm}
                      sdCard={controller.sdCard}
                      barometer={controller.barometer}
                      firmwares={controller.firmwares}
                      image={controller.image}
                      showImage={true}
                      basePath={basePath}
                    />
                  ))}
                </div>
              </section>
            ))}
          </div>
        </>
      ) : (
        <div class="text-center py-8 bg-muted/30 rounded-lg border-2 border-dashed border-muted">
          <p class="text-sm text-muted-foreground font-medium">No controllers using this sensor in database yet.</p>
        </div>
      )}
    </div>
  </MainLayout>
</BaseLayout>
