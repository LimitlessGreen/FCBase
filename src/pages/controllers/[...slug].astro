---
import { getCollection, getEntry } from 'astro:content';
import { buildRevisionVariants } from '@/content/config';
import DetailHeader from '@/components/detail/DetailHeader.astro';
import DetailPageLayout from '@/components/detail/DetailPageLayout.astro';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/Card';
import { Badge } from '@/components/ui/Badge';
import StatusBadge from '@/components/ui/StatusBadge.astro';
import ProfessionalTable from '@/components/table/ProfessionalTable.astro';
import TableSection from '@/components/table/TableSection.astro';
import TableRow from '@/components/table/TableRow.astro';
import TableRow2Col from '@/components/table/TableRow2Col.astro';
import SensorList from '@/components/SensorList.astro';
import { Picture } from 'astro:assets';
import {
  extractUniqueSensorIds,
  fetchSensorNameMap,
  mapSensorsWithNames,
  getManufacturerName,
  formatMounting,
  formatVoltageRange,
  formatDimensions,
  formatWeight,
  getPowerTypeLabel,
  formatPeripheralType,
  normalizePeripheralInterfaces,
} from '@/lib/data-utils';
import { 
  Cpu, 
  Package,
  Zap,
  Cable,
  Box,
  Layers,
} from 'lucide-react';

// Auto-import any local images placed in src/assets/images/controllers
const localControllerImages = import.meta.glob('/src/assets/images/controllers/*.{jpg,jpeg,png,webp,avif}', { eager: true, query: '?url', import: 'default' });
const localImageMap = Object.fromEntries(
  Object.entries(localControllerImages).map(([p, url]) => {
    const file = p.split('/').pop();
    const id = file.replace(/\.(jpg|jpeg|png|webp|avif)$/i, '');
    return [id, url];
  })
);
const resolveLocalPreview = (id) => {
  const plain = id.includes('/') ? id.split('/').pop() : id;
  const url = localImageMap[plain];
  if (!url) return undefined;
  const base = (import.meta.env.BASE_URL || '').replace(/\/$/, '');
  return base ? `${base}${url}` : url;
};

export async function getStaticPaths() {
  const controllers = await getCollection('controllers');
  return controllers.map((controller) => ({
    params: { slug: controller.id },
    props: { controller },
  }));
}

const { controller } = Astro.props;
const { data } = controller;

// Controller preview images
const controllerPreviewImages: Record<string, { src: any; credit: string; sourceUrl?: string }> = {
  'aocoda/aocoda-h743dual': {
    src: 'https://ardupilot.org/copter/_images/aocoda_h743dual.jpg',
    credit: 'ArduPilot Documentation',
    sourceUrl: 'https://ardupilot.org/copter/docs/common-aocoda-h743dual.html',
  },
  'cuav/cuav-7-nano': {
    src: 'https://ardupilot.org/copter/_images/7-nano.jpg',
    credit: 'ArduPilot Documentation',
    sourceUrl: 'https://ardupilot.org/copter/docs/common-CUAV-7-Nano.html',
  },
  'cuav/cuav-nora': {
    src: 'https://ardupilot.org/copter/_images/nora.png',
    credit: 'ArduPilot Documentation',
    sourceUrl: 'https://ardupilot.org/copter/docs/common-cuav-nora-overview.html',
  },
  'cuav/cuav-pixhawk-v6x': {
    src: 'https://ardupilot.org/copter/_images/cuav-pixhawk-v6x.jpg',
    credit: 'ArduPilot Documentation',
    sourceUrl: 'https://raw.githubusercontent.com/ArduPilot/ardupilot_wiki/master/common/source/docs/common-cuav-pixhawkv6X.rst',
  },
  'cubepilot/cubepilot-cube-black': {
    src: 'https://ardupilot.org/copter/_images/pixhawk2-overhead.jpg',
    credit: 'ArduPilot Documentation',
    sourceUrl: 'https://ardupilot.org/copter/docs/common-thecube-overview.html',
  },
  'cubepilot/cubepilot-cube-orange-plus': {
    src: 'https://ardupilot.org/copter/_images/Cube_orange_module.jpg',
    credit: 'ArduPilot Documentation',
    sourceUrl: 'https://ardupilot.org/copter/docs/common-thecubeorange-overview.html',
  },
  'holybro/holybro-durandal': {
    src: 'https://holybro.com/cdn/shop/products/Durandal-1.jpg?v=1751249914',
    credit: 'Holybro Store',
    sourceUrl: 'https://holybro.com/products/durandal',
  },
  'holybro/holybro-kakute-h7-v2': {
    src: 'https://holybro.com/cdn/shop/products/11058V2_1.jpg?v=1679456428',
    credit: 'Holybro Store',
    sourceUrl: 'https://holybro.com/products/kakute-h7-v2',
  },
  'holybro/holybro-pixhawk-4': {
    src: 'https://holybro.com/cdn/shop/files/110321_4.jpg?v=1750816088',
    credit: 'Holybro Store',
    sourceUrl: 'https://holybro.com/products/pixhawk-4',
  },
  'holybro/holybro-pixhawk-4-mini': {
    src: 'https://docs.px4.io/main/assets/pixhawk4mini_iso_1.ROPjkdrL.png',
    credit: 'PX4 Documentation',
    sourceUrl: 'https://docs.px4.io/main/en/flight_controller/pixhawk4_mini.html',
  },
  'holybro/holybro-pixhawk-5x': {
    src: 'https://holybro.com/cdn/shop/files/sku11045_4_grande.jpg?v=1723722819',
    credit: 'Holybro Store',
    sourceUrl: 'https://holybro.com/products/pixhawk-5x',
  },
  'holybro/holybro-pixhawk-6c': {
    src: 'https://holybro.com/cdn/shop/products/11054Pixhawk6C-Plasticcase_1_grande.jpg?v=1749537511',
    credit: 'Holybro Store',
    sourceUrl: 'https://holybro.com/products/pixhawk-6c',
  },
  'holybro/holybro-pixhawk-6x': {
    src: resolveLocalPreview('holybro/holybro-pixhawk-6x') ?? null,
    credit: 'Holybro Store',
    sourceUrl: 'https://holybro.com/products/pixhawk-6x',
  },
  'mateksys/mateksys-f405-wing': {
    src: 'https://www.mateksys.com/wp-content/uploads/2018/04/F405-WING_1-1500x600.jpg',
    credit: 'Mateksys',
    sourceUrl: 'https://www.mateksys.com/?portfolio=f405-wing',
  },
  'mateksys/mateksys-f765-wing': {
    src: 'https://www.mateksys.com/wp-content/uploads/2019/08/F765-WING_1-1500x600.jpg',
    credit: 'Mateksys',
    sourceUrl: 'https://www.mateksys.com/?portfolio=f765-wing',
  },
  'mateksys/mateksys-h743-wing': {
    src: 'https://www.mateksys.com/wp-content/uploads/2020/07/H743-WING_1.jpg',
    credit: 'Mateksys',
    sourceUrl: 'https://www.mateksys.com/?portfolio=h743-wing',
  },
  'mro/mro-pixracer-pro': {
    src: 'https://ardupilot.org/copter/_images/pixracer-pro-top.png',
    credit: 'ArduPilot Documentation',
    sourceUrl: 'https://ardupilot.org/copter/docs/common-pixracer-pro.html',
  },
};

const previewImage = controllerPreviewImages[controller.id] ?? null;

// Fetch related data
const manufacturer = data.brand ? await getEntry('manufacturers', data.brand) : null;
const manufacturerName = getManufacturerName(manufacturer, data.brand);
const mcu = data.mcu ? await getEntry('mcu', data.mcu) : null;
const firmware = await Promise.all(
  data.firmware_support.map(async (fw) => {
    const entry = await getEntry('firmware', fw.id);
    return { ...fw, name: entry?.data.title || entry?.data.name || fw.id };
  })
);

const revisionVariants = buildRevisionVariants(data);

// Use data-utils for sensor deduplication
const uniqueSensorIds = extractUniqueSensorIds(revisionVariants);
const sensorNameMap = await fetchSensorNameMap(uniqueSensorIds);

const revisionVariantsWithSensors = await Promise.all(
  revisionVariants.map(async (variant) => {
    const revision = variant.revision;
    const sourceEntries = revision?.sources
      ? await Promise.all(
          revision.sources.map(async (sourceId) => {
            const entry = await getEntry('sources', sourceId);
            return {
              id: sourceId,
              title: entry?.data.title ?? sourceId,
              url: entry?.data.url ?? null,
            };
          })
        )
      : [];

    const sensorDetails = {
      imu: mapSensorsWithNames(variant.spec.sensors?.imu, sensorNameMap),
      barometer: mapSensorsWithNames(variant.spec.sensors?.barometer, sensorNameMap),
      magnetometer: mapSensorsWithNames(variant.spec.sensors?.magnetometer, sensorNameMap),
    };

    return {
      ...variant,
      sourceEntries,
      sensorDetails,
    };
  })
);

const defaultVariantId = revisionVariantsWithSensors[0]?.id ?? 'base';
const hasMultipleVariants = revisionVariantsWithSensors.length > 1;
const hardwareRevisionSummaries = revisionVariantsWithSensors.filter(
  (variant) => variant.revision
);

const basePath = import.meta.env.BASE_URL.replace(/\/$/, '');
const controllerSlug = (controller as { slug?: string }).slug ?? controller.id;
const editPath = `src/content/controllers/${controllerSlug}.yaml`;
---

<DetailPageLayout
  title={`${data.title} - Flight Controller Database`}
  description={`${data.title} by ${manufacturerName} - ${data.mounting} mounting, ${data.mcu} MCU. Supports ${firmware.map(f => f.name).join(', ')}.`}
  editPath={editPath}
  breadcrumbs={[
    { href: `${basePath}/`, label: 'Home' },
    { href: `${basePath}/controllers`, label: 'Controllers' },
    { label: data.title },
  ]}
>
  <DetailHeader
    slot="header"
    title={data.title}
    subtitle={`by ${manufacturerName}`}
    description={data.notes}
  >
    <StatusBadge 
      slot="badges" 
      variant="verification" 
      status={data.verification.level}
      showIcon
      size="sm"
    />
    <StatusBadge 
      slot="badges" 
      variant="hardware" 
      status={data.hardware.openness}
      size="sm"
    >
      {data.hardware.openness.charAt(0).toUpperCase() + data.hardware.openness.slice(1)} Hardware
    </StatusBadge>
  </DetailHeader>

  <!-- Hero Image Banner -->
  {previewImage && (
    <div class="relative w-full mb-8 overflow-hidden rounded-xl border border-border shadow-lg bg-gradient-to-br from-muted via-background to-muted">
      <div class="relative aspect-[21/9]">
        {typeof previewImage.src === 'string' ? (
          <img
            src={previewImage.src}
            alt={data.title}
            loading="eager"
            class="h-full w-full object-contain"
          />
        ) : (
          <Picture
            src={previewImage.src}
            alt={data.title}
            formats={['avif', 'webp', 'jpg']}
            widths={[1200, 1600, 2000]}
            sizes="(max-width: 768px) 100vw, (max-width: 1200px) 90vw, 1200px"
            loading="eager"
            class="h-full w-full object-contain"
          />
        )}
        
        <!-- Image Credit Overlay -->
        {previewImage.credit && (
          <div class="absolute bottom-4 right-4 rounded-sm bg-background/90 backdrop-blur-sm px-3 py-2 shadow-sm border border-border/40">
            {previewImage.sourceUrl ? (
              <a
                href={previewImage.sourceUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="text-xs font-medium text-muted-foreground hover:text-foreground transition-colors inline-flex items-center gap-1.5"
              >
                <span>Image: {previewImage.credit}</span>
                <span class="text-primary">↗</span>
              </a>
            ) : (
              <span class="text-xs font-medium text-muted-foreground">
                Image: {previewImage.credit}
              </span>
            )}
          </div>
        )}
      </div>
    </div>
  )}

  <!-- Main Content - Ultra Compact Layout -->
  <div class="grid grid-cols-1 gap-4 mb-8 lg:grid-cols-4">
    <!-- Left Column - Complete Specs Table -->
    <div class="lg:col-span-3">
      <Card>
        <CardHeader>
          <CardTitle className="text-lg">Technical Specifications</CardTitle>
        </CardHeader>
        <CardContent>
          <div
            class="space-y-4"
            data-revision-root
            data-default-variant={defaultVariantId}
          >
            {hasMultipleVariants && (
              <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                <div class="sm:hidden w-full space-y-1">
                  <label
                    for="hardware-revision-select"
                    class="text-[10px] uppercase tracking-wide font-semibold text-muted-foreground"
                  >
                    Hardware revision
                  </label>
                  <select
                    id="hardware-revision-select"
                    data-revision-select
                    class="w-full rounded-sm border border-border/60 bg-background px-3 py-2 text-sm text-foreground focus:outline-hidden focus:ring-2 focus:ring-primary/40"
                  >
                    {revisionVariantsWithSensors.map((variant) => (
                      <option value={variant.id}>{variant.label}</option>
                    ))}
                  </select>
                </div>
                <div
                  class="hidden sm:flex flex-wrap gap-2"
                  role="tablist"
                  aria-label="Hardware revisions"
                >
                  {revisionVariantsWithSensors.map((variant, idx) => (
                    <button
                      type="button"
                      data-revision-tab={variant.id}
                      class={`border rounded-sm px-3 py-1.5 text-sm font-medium transition-colors ${idx === 0 ? 'bg-primary/10 border-primary/40 text-primary' : 'bg-muted/30 border-border/60 text-muted-foreground'}`}
                      aria-selected={idx === 0 ? 'true' : 'false'}
                    >
                      {variant.label}
                    </button>
                  ))}
                </div>
              </div>
            )}
              {revisionVariantsWithSensors.map((variant, idx) => (
                <section
                  key={variant.id}
                  data-revision-panel={variant.id}
                  class={`space-y-4 ${idx === 0 ? '' : 'hidden'}`}
                  aria-hidden={idx === 0 ? 'false' : 'true'}
                >
                  {variant.revision ? (
                    <div class="rounded-sm border border-border/40 bg-muted/30 p-3 space-y-2">
                      <div class="flex flex-wrap items-center justify-between gap-2">
                        <div class="flex flex-wrap items-center gap-2">
                          <Badge className="text-[10px] uppercase tracking-wide bg-primary/10 text-primary border-primary/20">
                            {variant.label}
                          </Badge>
                          {variant.revision.released && (
                            <span class="text-xs font-mono text-muted-foreground">
                              {variant.revision.released}
                            </span>
                          )}
                        </div>
                        <span class="text-xs font-semibold text-muted-foreground">
                          Revision overview
                        </span>
                      </div>
                      {variant.revision.notes && (
                        <p class="text-xs leading-snug text-muted-foreground">
                          {variant.revision.notes}
                        </p>
                      )}
                      {variant.revision.changes && variant.revision.changes.length > 0 && (
                        <ul class="space-y-1">
                          {variant.revision.changes.map((change, changeIdx) => (
                            <li
                              key={`${variant.id}-change-${changeIdx}`}
                              class="flex items-start gap-2 text-xs text-muted-foreground"
                            >
                              <span class="text-primary font-bold mt-0.5">•</span>
                              <span class="leading-snug text-foreground">{change}</span>
                            </li>
                          ))}
                        </ul>
                      )}
                      {variant.revision.overrides && (
                        <div class="flex flex-wrap gap-1.5">
                          {variant.revision.overrides.sensors && (
                            <Badge className="text-[10px] uppercase tracking-wide bg-purple-500/10 text-purple-500 border-purple-500/30">
                              Sensor overrides
                            </Badge>
                          )}
                          {variant.revision.overrides.io && (
                            <Badge className="text-[10px] uppercase tracking-wide bg-blue-500/10 text-blue-500 border-blue-500/30">
                              I/O overrides
                            </Badge>
                          )}
                          {variant.revision.overrides.power && (
                            <Badge className="text-[10px] uppercase tracking-wide bg-amber-500/10 text-amber-500 border-amber-500/30">
                              Power overrides
                            </Badge>
                          )}
                        </div>
                      )}
                      {variant.sourceEntries.length > 0 && (
                        <div class="flex flex-wrap gap-1.5">
                          {variant.sourceEntries.map((source) =>
                            source.url ? (
                              <a
                                key={source.id}
                                href={source.url}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="text-[10px] uppercase tracking-wide font-semibold inline-flex items-center gap-1 rounded-sm border border-primary/30 bg-primary/5 px-2 py-1 text-primary hover:bg-primary/10 transition-colors"
                              >
                                {source.title}
                                <span>↗</span>
                              </a>
                            ) : (
                              <span
                                key={source.id}
                                class="text-[10px] uppercase tracking-wide font-semibold inline-flex items-center gap-1 rounded-sm border border-border/40 bg-muted/30 px-2 py-1 text-muted-foreground"
                              >
                                {source.title}
                              </span>
                            )
                          )}
                        </div>
                      )}
                    </div>
                  ) : (
                    <div class="rounded-sm border border-border/40 bg-muted/20 p-3 space-y-2">
                      <div class="flex flex-wrap items-center justify-between gap-2">
                        <span class="text-sm font-semibold text-foreground">
                          Base hardware specification
                        </span>
                        <Badge className="text-[10px] uppercase tracking-wide bg-primary/10 text-primary border-primary/20">
                          Default
                        </Badge>
                      </div>
                      {data.hardware.notes && (
                        <p class="text-xs leading-snug text-muted-foreground">{data.hardware.notes}</p>
                      )}
                    </div>
                  )}
                  <ProfessionalTable>
                    <TableSection title="Core Hardware" color="blue" />
                    
                    <TableRow2Col
                      label1="MCU"
                      value1={mcu?.data.title || mcu?.data.name || variant.spec.mcu}
                      label2="Mounting"
                      value2={formatMounting(variant.spec.mounting)}
                      mono1
                      mono2
                    />
                    
                    {variant.spec.dimensions && (
                      <TableRow2Col
                        label1="Dimensions"
                        value1={formatDimensions(variant.spec.dimensions)}
                        label2="Weight"
                        value2={formatWeight(variant.spec.dimensions.weight_g) || '—'}
                        mono1
                        mono2
                      />
                    )}
                    <TableSection title="Power" color="orange" />
                    
                    {variant.spec.power.inputs && variant.spec.power.inputs.length > 0 ? (
                      <>
                        <TableRow label="Power Inputs">
                          <div class="space-y-2">
                            {variant.spec.power.inputs.map((input, idx) => {
                              const voltageLabel = formatVoltageRange(input.voltage);
                              const typeLabel = getPowerTypeLabel(input.type);
                              return (
                                <div
                                  key={`${input.name}-${idx}`}
                                  class="rounded-sm border border-border/40 bg-muted/20 p-3 space-y-1"
                                >
                                  <div class="flex flex-wrap items-center justify-between gap-2">
                                    <span class="font-mono font-semibold text-sm text-foreground">
                                      {input.name}
                                    </span>
                                    {typeLabel && (
                                      <span class="text-[10px] uppercase tracking-wide text-muted-foreground">
                                        {typeLabel}
                                      </span>
                                    )}
                                  </div>
                                  {input.connector && (
                                    <div class="text-xs text-muted-foreground">
                                      Connector:&nbsp;
                                      <span class="font-mono text-foreground">{input.connector}</span>
                                    </div>
                                  )}
                                  {voltageLabel && (
                                    <div class="text-xs text-muted-foreground">
                                      Voltage:&nbsp;
                                      <span class="font-semibold text-foreground">{voltageLabel}</span>
                                    </div>
                                  )}
                                  {input.notes && (
                                    <p class="text-xs text-muted-foreground leading-snug">{input.notes}</p>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        </TableRow>
                        {variant.spec.power.redundant && (
                          <TableRow 
                            label="Redundancy" 
                            value="✓ Yes"
                            class="font-semibold text-green-600 dark:text-green-400"
                          />
                        )}
                      </>
                    ) : (
                      <>
                        <TableRow2Col
                          label1="Input Voltage"
                          value1={variant.spec.power.voltage_in ?? '—'}
                          label2="Redundancy"
                          value2={variant.spec.power.redundant ? '✓ Yes' : '—'}
                          mono1
                        />
                      </>
                    )}
                    {variant.spec.power.notes && (
                      <TableRow label=" " class="text-xs text-muted-foreground italic">
                        {variant.spec.power.notes}
                      </TableRow>
                    )}
                    <TableSection title="Connectivity & I/O" color="green" />
                    
                    <TableRow2Col
                      label1="UARTs"
                      value1={variant.spec.io.uarts}
                      label2="CAN Bus"
                      value2={variant.spec.io.can}
                    />
                    
                    <TableRow2Col
                      label1="PWM Outputs"
                      value1={variant.spec.io.pwm}
                      label2="SD Card"
                      value2={variant.spec.io.sd_card ? '✓ Yes' : '✗ No'}
                    />
                    
                    {variant.spec.io.ethernet !== undefined && (
                      <TableRow
                        label="Ethernet"
                        value={variant.spec.io.ethernet ? '✓ Yes' : '✗ No'}
                      />
                    )}
                    
                    {variant.spec.io.peripherals && variant.spec.io.peripherals.length > 0 && (
                      <TableRow label="Peripheral Ports">
                        <div class="grid gap-3 sm:grid-cols-2">
                          {variant.spec.io.peripherals.map((peripheral, idx) => (
                            <div
                              class="rounded-sm border border-border/40 bg-background/70 p-3 shadow-xs"
                              key={`${peripheral.name}-${idx}`}
                            >
                              <div class="flex items-center justify-between gap-2">
                                <span class="font-semibold text-sm text-foreground">
                                  {peripheral.name}
                                  {peripheral.count && (
                                    <span class="ml-1 text-xs text-muted-foreground font-medium">
                                      ×{peripheral.count}
                                    </span>
                                  )}
                                </span>
                                <Badge className="text-[10px] tracking-wide font-medium">
                                  {formatPeripheralType(peripheral.type)}
                                </Badge>
                              </div>
                              {(() => {
                                const interfaceBadges = normalizePeripheralInterfaces(
                                  peripheral.interfaces,
                                );
                                if (interfaceBadges.length === 0) return null;
                                return (
                                  <div class="mt-2 flex flex-wrap gap-1.5">
                                    {interfaceBadges.map(({ label, count }) => (
                                      <Badge
                                        variant="secondary"
                                        className="text-[10px] tracking-wide font-medium"
                                        key={`${peripheral.name}-${label}`}
                                      >
                                        <span>{label}</span>
                                        {count > 1 && (
                                          <span className="ml-1 text-[10px] text-muted-foreground font-semibold">
                                            ×{count}
                                          </span>
                                        )}
                                      </Badge>
                                    ))}
                                  </div>
                                );
                              })()}
                              {peripheral.connector && (
                                <p class="mt-2 text-xs text-muted-foreground">
                                  <span class="font-medium text-foreground">Connector:</span>&nbsp;{peripheral.connector}
                                </p>
                              )}
                              {peripheral.voltage && (
                                <p class="text-xs text-muted-foreground">
                                  <span class="font-medium text-foreground">Voltage:</span> {peripheral.voltage}
                                </p>
                              )}
                              {peripheral.notes && (
                                <p class="text-xs text-muted-foreground leading-snug mt-1">
                                  {peripheral.notes}
                                </p>
                              )}
                            </div>
                          ))}
                        </div>
                      </TableRow>
                    )}
                    <TableSection title="Onboard Sensors" color="purple" />
                    
                    {variant.sensorDetails.imu.length > 0 && (
                      <TableRow label="IMU">
                        <SensorList 
                          sensors={variant.sensorDetails.imu.map(s => ({
                            id: s.id,
                            name: s.name ?? s.id,
                            instances: s.count
                          }))}
                          linkable={true}
                          size="sm"
                        />
                      </TableRow>
                    )}
                    
                    {variant.sensorDetails.barometer.length > 0 && (
                      <TableRow label="Barometer">
                        <SensorList 
                          sensors={variant.sensorDetails.barometer.map(s => ({
                            id: s.id,
                            name: s.name ?? s.id,
                            instances: s.count
                          }))}
                          linkable={true}
                          size="sm"
                        />
                      </TableRow>
                    )}
                    
                    {variant.sensorDetails.magnetometer.length > 0 && (
                      <TableRow label="Magnetometer">
                        <SensorList 
                          sensors={variant.sensorDetails.magnetometer.map(s => ({
                            id: s.id,
                            name: s.name ?? s.id,
                            instances: s.count
                          }))}
                          linkable={true}
                          size="sm"
                        />
                      </TableRow>
                    )}
                    {data.features && data.features.length > 0 && (
                      <>
                        <TableSection title="Additional Features" color="green" />
                        <TableRow label=" ">
                          <ul class="grid grid-cols-2 gap-x-4 gap-y-1.5 text-sm">
                            {data.features.map((feature) => (
                              <li class="flex items-start gap-2" key={feature}>
                                <span class="text-emerald-600 dark:text-emerald-400 font-bold text-sm mt-0.5">✓</span>
                                <span class="font-medium">{feature}</span>
                              </li>
                            ))}
                          </ul>
                        </TableRow>
                      </>
                    )}
                  </ProfessionalTable>
                </section>
              ))}
            </div>
            {hasMultipleVariants && (
              <script type="module">
                const script = document.currentScript;
                const root = script?.parentElement?.querySelector('[data-revision-root]');
                if (!root) return;
                const defaultId = root.dataset.defaultVariant;
                const tabs = Array.from(root.querySelectorAll('[data-revision-tab]'));
                const panels = Array.from(root.querySelectorAll('[data-revision-panel]'));
                const select = root.querySelector('[data-revision-select]');
                const activeClasses = ['bg-primary/10', 'border-primary/40', 'text-primary'];
                const inactiveClasses = ['bg-muted/30', 'border-border/60', 'text-muted-foreground'];
                const setActive = (id) => {
                  panels.forEach((panel) => {
                    const isActive = panel.dataset.revisionPanel === id;
                    panel.classList.toggle('hidden', !isActive);
                    panel.setAttribute('aria-hidden', isActive ? 'false' : 'true');
                  });
                  tabs.forEach((tab) => {
                    const isActive = tab.dataset.revisionTab === id;
                    tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
                    activeClasses.forEach((cls) => tab.classList.toggle(cls, isActive));
                    inactiveClasses.forEach((cls) => tab.classList.toggle(cls, !isActive));
                  });
                  if (select && select.value !== id) {
                    select.value = id;
                  }
                };
                tabs.forEach((tab) => {
                  tab.addEventListener('click', () => setActive(tab.dataset.revisionTab));
                });
                if (select) {
                  select.addEventListener('change', (event) => setActive(event.target.value));
                }
                if (defaultId) {
                  setActive(defaultId);
                }
              </script>
            )}
          </CardContent>
        </Card>
      </div>

      <!-- Right Column - Professional Sidebar -->
      <div class="space-y-4">
        <!-- Firmware & Info Combined -->
        <Card>
          <CardHeader>
            <CardTitle className="text-base font-bold uppercase tracking-wide text-primary">Quick Reference</CardTitle>
          </CardHeader>
          <CardContent>
            <ProfessionalTable class="text-xs">
              <TableSection title="Firmware Support" color="blue" colspan={2} />
              {firmware.map((fw) => (
                <tr class="even:bg-muted/30 hover:bg-muted/50 transition-colors" key={fw.id}>
                  <td class="px-2 py-1.5 font-semibold">{fw.name}</td>
                  <td class="px-2 py-1.5 text-right">
                    <StatusBadge 
                      variant="firmware" 
                      status={fw.status}
                      size="xs"
                    />
                  </td>
                </tr>
              ))}
              
              <TableSection title="Information" color="gray" colspan={2} />
              <tr class="even:bg-muted/30 hover:bg-muted/50 transition-colors">
                <td class="px-2 py-1.5 text-muted-foreground font-medium">Verification</td>
                <td class="px-2 py-1.5 text-right">
                  <StatusBadge 
                    variant="verification" 
                    status={data.verification.level}
                    size="xs"
                  />
                </td>
              </tr>
              <tr class="even:bg-muted/30 hover:bg-muted/50 transition-colors">
                <td class="px-2 py-1.5 text-muted-foreground font-medium">Hardware</td>
                <td class="px-2 py-1.5 text-right">
                  <StatusBadge 
                    variant="hardware" 
                    status={data.hardware.openness}
                    size="xs"
                  />
                </td>
              </tr>
              <tr class="even:bg-muted/30 hover:bg-muted/50 transition-colors">
                <td class="px-2 py-1.5 text-muted-foreground font-medium">Updated</td>
                <td class="px-2 py-1.5 font-mono font-semibold text-right">{data.verification.last_updated}</td>
              </tr>
              <tr class="even:bg-muted/30 hover:bg-muted/50 transition-colors">
                <td class="px-2 py-1.5 text-muted-foreground font-medium">Sources</td>
                <td class="px-2 py-1.5 font-mono font-semibold text-right">{data.sources.length}</td>
              </tr>
              {manufacturer?.data.website && (
                <tr class="even:bg-muted/30 hover:bg-muted/50 transition-colors">
                  <td class="px-2 py-1.5 text-muted-foreground font-medium">Manufacturer</td>
                  <td class="px-2 py-1.5 text-right">
                    <a 
                      href={manufacturer.data.website} 
                      target="_blank" 
                      rel="noopener noreferrer"
                      class="font-semibold hover:text-primary transition-colors text-xs inline-flex items-center gap-1"
                    >
                      {manufacturer.data.name}
                      <span class="text-primary">→</span>
                    </a>
                  </td>
                </tr>
              )}
            </ProfessionalTable>
          </CardContent>
        </Card>
        {hardwareRevisionSummaries.length > 0 && (
          <Card>
            <CardHeader>
              <CardTitle className="text-base font-bold uppercase tracking-wide text-primary">
                Hardware Revisions
              </CardTitle>
              {data.hardware.notes && (
                <CardDescription className="text-xs text-muted-foreground leading-relaxed">
                  {data.hardware.notes}
                </CardDescription>
              )}
            </CardHeader>
            <CardContent>
              <div class="space-y-3">
                {hardwareRevisionSummaries.map((variant) => {
                  const revision = variant.revision!;
                  return (
                    <div
                      key={variant.id}
                      class="rounded-sm border border-border/40 bg-background/70 p-3 shadow-xs"
                    >
                      <div class="flex flex-wrap items-center justify-between gap-2">
                        <span class="font-semibold text-sm text-foreground">{variant.label}</span>
                        {revision.released && (
                          <Badge className="text-[10px] uppercase tracking-wide bg-primary/10 text-primary border-primary/20">
                            {revision.released}
                          </Badge>
                        )}
                      </div>
                      {revision.notes && (
                        <p class="mt-1 text-xs leading-snug text-muted-foreground">{revision.notes}</p>
                      )}
                      {revision.changes && revision.changes.length > 0 && (
                        <ul class="mt-2 space-y-1">
                          {revision.changes.map((change, changeIdx) => (
                            <li
                              key={`${variant.id}-change-${changeIdx}`}
                              class="flex items-start gap-2 text-xs text-muted-foreground"
                            >
                              <span class="text-primary font-bold mt-0.5">•</span>
                              <span class="leading-snug text-foreground">{change}</span>
                            </li>
                          ))}
                        </ul>
                      )}
                      {revision.overrides && (
                        <div class="mt-2 flex flex-wrap gap-1.5">
                          {revision.overrides.sensors && (
                            <Badge className="text-[10px] uppercase tracking-wide bg-purple-500/10 text-purple-500 border-purple-500/30">
                              Sensor overrides
                            </Badge>
                          )}
                          {revision.overrides.io && (
                            <Badge className="text-[10px] uppercase tracking-wide bg-blue-500/10 text-blue-500 border-blue-500/30">
                              I/O overrides
                            </Badge>
                          )}
                          {revision.overrides.power && (
                            <Badge className="text-[10px] uppercase tracking-wide bg-amber-500/10 text-amber-500 border-amber-500/30">
                              Power overrides
                            </Badge>
                          )}
                        </div>
                      )}
                      {variant.sourceEntries.length > 0 && (
                        <div class="mt-2 flex flex-wrap gap-1.5">
                          {variant.sourceEntries.map((source) =>
                            source.url ? (
                              <a
                                key={source.id}
                                href={source.url}
                                target="_blank"
                                rel="noopener noreferrer"
                                class="text-[10px] uppercase tracking-wide font-semibold inline-flex items-center gap-1 rounded-sm border border-primary/30 bg-primary/5 px-2 py-1 text-primary hover:bg-primary/10 transition-colors"
                              >
                                {source.title}
                                <span>↗</span>
                              </a>
                            ) : (
                              <span
                                key={source.id}
                                class="text-[10px] uppercase tracking-wide font-semibold inline-flex items-center gap-1 rounded-sm border border-border/40 bg-muted/30 px-2 py-1 text-muted-foreground"
                              >
                                {source.title}
                              </span>
                            )
                          )}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </CardContent>
          </Card>
        )}
      </div>
    </div>
  </div>
</DetailPageLayout>
