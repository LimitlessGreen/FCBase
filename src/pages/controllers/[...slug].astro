---
import { getCollection, getEntry } from 'astro:content';
import { buildRevisionVariants, type KnownIssue } from '@/content/config';
import DetailHeader from '@/components/detail/DetailHeader.astro';
import PowerSummaryBadge from '@/components/detail/PowerSummaryBadge.astro';
import DetailPageLayout from '@/components/detail/DetailPageLayout.astro';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/Card';
import { Badge } from '@/components/ui/Badge';
import { buttonVariants } from '@/components/ui/Button';
import StatusBadge from '@/components/ui/StatusBadge.astro';
import SpecItem from '@/components/ui/SpecItem.astro';
import ResourceLinkList from '@/components/ResourceLinkList.astro';
import ProfessionalTable from '@/components/table/ProfessionalTable.astro';
import TableSection from '@/components/table/TableSection.astro';
import TableRow from '@/components/table/TableRow.astro';
import TableRow2Col from '@/components/table/TableRow2Col.astro';
import SensorList from '@/components/SensorList.astro';
import { GITHUB_EDIT_BASE_URL } from '@/lib/constants';
import {
  extractUniqueSensorIds,
  mapSensorsWithNames,
  getManufacturerName,
  formatMounting,
  formatVoltageRange,
  formatDimensions,
  formatWeight,
  getPowerTypeLabel,
  formatPeripheralType,
  normalizePeripheralInterfaces,
} from '@/lib/data-utils';
import { cn } from '@/lib/utils';
import { resolveControllerPreviewImage } from '@/lib/controller-images';
import {
  getFirmwareMap,
  getManufacturersMap,
  getSensorsMap,
  getSourcesMap,
} from '@/lib/content-cache';
import { createControllerProductLd, resolveControllerSummary } from '@/lib/controller-seo';
import {
  Cpu,
  Package,
  Zap,
  Cable,
  Layers,
  AlertTriangle,
  BookOpen,
  CircuitBoard,
  Github,
  Store,
  ExternalLink,
  Pencil,
} from 'lucide-react';
import { getBasePath, getSiteUrl } from '@/lib/paths';
import { Picture } from 'astro:assets';

type ResourceKind = 'datasheet' | 'ardupilot' | 'px4' | 'hardware';

type ResourceLink = {
  kind: ResourceKind;
  url: string;
  title: string;
};

export async function getStaticPaths() {
  const controllers = await getCollection('controllers');
  return controllers.map((controller) => ({
    params: { slug: controller.id },
    props: { controller },
  }));
}

const { controller } = Astro.props;
const { data } = controller;

const previewImage = resolveControllerPreviewImage(controller) ?? null;
const heroAlt = previewImage?.alt ?? data.title;

const heroSizes = '(max-width: 1024px) 100vw, 600px';

const heroImage = previewImage?.src && typeof previewImage.src !== 'string' ? previewImage.src : null;

const remotePreview = previewImage && typeof previewImage.src === 'string'
  ? {
      src: previewImage.src,
      width: previewImage.width ?? 1280,
      height: previewImage.height ?? 720,
    }
  : null;

// Fetch related data
const manufacturers = await getManufacturersMap();
const manufacturer = data.brand ? manufacturers.get(data.brand) ?? null : null;
const manufacturerName = getManufacturerName(manufacturer, data.brand);
const mcu = data.mcu ? await getEntry('mcu', data.mcu) : null;
const firmwareMap = await getFirmwareMap();

const revisionVariants = buildRevisionVariants(data);

// Use data-utils for sensor deduplication
const uniqueSensorIds = extractUniqueSensorIds(revisionVariants);
const sensorsMap = await getSensorsMap();
const sourcesMap = await getSourcesMap();

type SourceEntry = {
  id: string;
  url: string;
  title: string;
  type: string;
  publisher: string;
};

const normalizeSourceEntries = (sourceIds: string[] | undefined): SourceEntry[] => {
  if (!Array.isArray(sourceIds)) return [];

  return sourceIds
    .map((sourceId) => {
      const entry = sourcesMap.get(sourceId);
      if (!entry?.data) return null;

      const data = entry.data as {
        url?: string | null;
        title?: string | null;
        type?: string | null;
        publisher?: string | null;
      };

      if (!data.url) return null;

      return {
        id: sourceId,
        url: data.url,
        title: data.title ?? sourceId,
        type: (data.type ?? '').toString().toLowerCase(),
        publisher: (data.publisher ?? '').toString().toLowerCase(),
      };
    })
    .filter((entry): entry is SourceEntry => Boolean(entry));
};

const matchesResourceKind = (source: SourceEntry, kind: ResourceKind): boolean => {
  const haystack = `${source.id} ${source.type} ${source.publisher} ${source.title}`.toLowerCase();

  switch (kind) {
    case 'datasheet':
      return haystack.includes('datasheet');
    case 'ardupilot':
      return haystack.includes('ardupilot');
    case 'px4':
      return haystack.includes('px4');
    case 'hardware':
      return (
        haystack.includes('hardware') ||
        haystack.includes('manufacturer') ||
        haystack.includes('product') ||
        haystack.includes('reference')
      );
    default:
      return false;
  }
};

const resolveResourceLink = (
  entries: SourceEntry[],
  kind: ResourceKind
): ResourceLink | null => {
  const entry = entries.find((source) => matchesResourceKind(source, kind));
  if (!entry) return null;

  return { kind, url: entry.url, title: entry.title };
};

const sensorMetadataMap = new Map<
  string,
  { name: string; issues: KnownIssue[]; links: ResourceLink[] }
>();
const sensorNameMap = new Map<string, string>();

const registerSensorMetadata = (sensorId: string) => {
  if (!sensorMetadataMap.has(sensorId)) {
    const entry = sensorsMap.get(sensorId);
    const name = entry?.data.title ?? entry?.data.name ?? sensorId;
    const issues = Array.isArray(entry?.data.known_issues)
      ? entry.data.known_issues
      : [];
    const links: ResourceLink[] = [];

    const datasheetUrl = entry?.data.datasheet?.url ?? null;
    if (datasheetUrl) {
      links.push({ kind: 'datasheet', url: datasheetUrl, title: `${name} datasheet` });
    }

    const sourceEntries = normalizeSourceEntries(entry?.data.sources);
    const seenKinds = new Set<ResourceKind>(links.map((link) => link.kind));

    (['ardupilot', 'px4', 'hardware'] as ResourceKind[]).forEach((kind) => {
      if (seenKinds.has(kind)) return;
      const link = resolveResourceLink(sourceEntries, kind);
      if (link) {
        links.push(link);
        seenKinds.add(kind);
      }
    });

    sensorMetadataMap.set(sensorId, { name, issues, links });
    sensorNameMap.set(sensorId, name);
  }

  return sensorMetadataMap.get(sensorId)!;
};

uniqueSensorIds.forEach((sensorId) => {
  registerSensorMetadata(sensorId);
});

const revisionVariantsWithSensors = revisionVariants.map((variant) => {
  const revision = variant.revision;
  const sourceEntries = revision?.sources
    ? revision.sources.map((sourceId) => {
        const entry = sourcesMap.get(sourceId);
        return {
          id: sourceId,
          title: entry?.data.title ?? sourceId,
          url: entry?.data.url ?? null,
        };
      })
    : [];

  (['imu', 'barometer', 'magnetometer'] as const).forEach((category) => {
    variant.spec.sensors?.[category]?.forEach((sensor) => {
      registerSensorMetadata(sensor.id);
    });
  });

  const enrichSensors = <T extends { id: string }>(
    sensors: T[] | undefined
  ) =>
    mapSensorsWithNames(sensors, sensorNameMap).map((sensor) => ({
      ...sensor,
      links: sensorMetadataMap.get(sensor.id)?.links ?? [],
    }));

  const sensorDetails = {
    imu: enrichSensors(variant.spec.sensors?.imu),
    barometer: enrichSensors(variant.spec.sensors?.barometer),
    magnetometer: enrichSensors(variant.spec.sensors?.magnetometer),
  };

  return {
    ...variant,
    sourceEntries,
    sensorDetails,
  };
});

const defaultVariantId = revisionVariantsWithSensors[0]?.id ?? 'base';
const hasMultipleVariants = revisionVariantsWithSensors.length > 1;
const hardwareRevisionSummaries = revisionVariantsWithSensors.filter(
  (variant) => variant.revision
);

const basePath = getBasePath();
const manufacturerUrl = manufacturer ? `${basePath}/manufacturers/${manufacturer.id}` : null;
const controllerSlug = (controller as { slug?: string }).slug ?? controller.id;
const editPath = `src/content/controllers/${controllerSlug}.yaml`;
const mcuName = mcu?.data.title ?? mcu?.data.name ?? data.mcu;
const formattedMounting = data.mounting ? formatMounting(data.mounting) : 'Custom';
const summaryResult = resolveControllerSummary(data, () =>
  `Detailed specifications for the ${data.title} flight controller by ${manufacturerName}, built around the ${mcuName ?? 'primary'} MCU with a ${formattedMounting} mounting pattern.`
);
const pageDescription = summaryResult.metaDescription;
const pageTitle = `${data.title} by ${manufacturerName} | FCBase`;
const canonicalUrl = getSiteUrl(`controllers/${controllerSlug}`, Astro.site);
const ogTitle = pageTitle;
const ogImageUrl = getSiteUrl(`controllers/og/${controllerSlug}.png`, Astro.site);
const ogImageAlt = `${data.title} flight controller technical summary`;

const mcuFamilyName = mcu?.data.family ?? data.mcu_family ?? null;
const hasSdCard = data.io?.sd_card === true;
const canCount = typeof data.io?.can === 'number' ? data.io.can : null;
const hasCanBus = typeof canCount === 'number' ? canCount > 0 : Boolean(data.io?.can === true);
const uartsCount = typeof data.io?.uarts === 'number' ? data.io.uarts : null;
const additionalProperties = [
  data.mcu
    ? { '@type': 'PropertyValue', name: 'MCU', value: mcuName ?? data.mcu }
    : null,
  typeof data.io?.uarts === 'number'
    ? { '@type': 'PropertyValue', name: 'UARTs', value: data.io.uarts }
    : null,
  typeof data.io?.can === 'number'
    ? { '@type': 'PropertyValue', name: 'CAN', value: data.io.can }
    : null,
  typeof data.io?.sd_card === 'boolean'
    ? { '@type': 'PropertyValue', name: 'SD', value: data.io.sd_card ? 'Yes' : 'No' }
    : null,
  data.mounting
    ? { '@type': 'PropertyValue', name: 'Mounting', value: formattedMounting }
    : null,
].filter(Boolean);
const productLd = createControllerProductLd({
  controllerId: controller.id,
  title: data.title,
  description: summaryResult.summary,
  canonicalUrl,
  imageUrl: ogImageUrl,
  manufacturerName,
  additionalProperties,
});
const productLdJson = JSON.stringify(productLd, null, 2);

const normalizedEditPath = editPath.replace(/^\/+/, '');
const editUrl = normalizedEditPath ? `${GITHUB_EDIT_BASE_URL}/${normalizedEditPath}` : null;

const controllerSourceEntries = normalizeSourceEntries(data.sources);
const controllerArdupilotLink = resolveResourceLink(controllerSourceEntries, 'ardupilot');
const controllerPx4Link = resolveResourceLink(controllerSourceEntries, 'px4');
const controllerHardwareLink = resolveResourceLink(controllerSourceEntries, 'hardware');
const controllerDatasheetLink = resolveResourceLink(controllerSourceEntries, 'datasheet');

const controllerResourceLinks = [
  controllerDatasheetLink,
  controllerArdupilotLink,
  controllerPx4Link,
  controllerHardwareLink,
].filter((link): link is ResourceLink => Boolean(link));

const mcuSourceEntries = mcu ? normalizeSourceEntries(mcu.data.sources) : [];
const mcuResourceLinks = [
  mcu?.data.datasheet?.url
    ? ({
        kind: 'datasheet',
        url: mcu.data.datasheet.url,
        title: mcu.data.datasheet.title ?? `${mcuName} datasheet`,
      } satisfies ResourceLink)
    : null,
  resolveResourceLink(mcuSourceEntries, 'hardware'),
  resolveResourceLink(mcuSourceEntries, 'ardupilot'),
  resolveResourceLink(mcuSourceEntries, 'px4'),
].filter((link): link is ResourceLink => Boolean(link));

const firmwareDocMap = new Map<string, string>();
if (controllerArdupilotLink) {
  firmwareDocMap.set('ardupilot', controllerArdupilotLink.url);
}
if (controllerPx4Link) {
  firmwareDocMap.set('px4', controllerPx4Link.url);
}

const firmware = data.firmware_support.map((fw) => {
  const entry = firmwareMap.get(fw.id);
  return {
    ...fw,
    name: entry?.data.title || entry?.data.name || fw.id,
    docUrl: firmwareDocMap.get(fw.id) ?? null,
  };
});

const countPeripheralsByType = (type: string) =>
  data.io.peripherals?.reduce((total, peripheral) => {
    if (peripheral.type !== type) return total;
    return total + (typeof peripheral.count === 'number' ? peripheral.count : 1);
  }, 0) ?? 0;

const i2cCount = countPeripheralsByType('i2c');
const spiCount = countPeripheralsByType('spi');

const ioSummaryParts: string[] = [];
if (typeof data.io.uarts === 'number') {
  ioSummaryParts.push(`${data.io.uarts} UART${data.io.uarts === 1 ? '' : 's'}`);
}
if (i2cCount > 0) {
  ioSummaryParts.push(`${i2cCount} IÂ²C`);
}
if (spiCount > 0) {
  ioSummaryParts.push(`${spiCount} SPI`);
}
if (typeof data.io.can === 'number' && data.io.can > 0) {
  ioSummaryParts.push(`${data.io.can} CAN`);
}
const ioSummary = ioSummaryParts.length > 0 ? ioSummaryParts.join(' â€¢ ') : 'â€”';

const pwmSummaryParts: string[] = [];
if (typeof data.io.pwm === 'number') {
  pwmSummaryParts.push(`${data.io.pwm} PWM ${data.io.pwm === 1 ? 'output' : 'outputs'}`);
}
const sdCardStatus = data.io?.sd_card;
if (sdCardStatus === true) {
  pwmSummaryParts.push('microSD logging');
} else if (sdCardStatus === false) {
  pwmSummaryParts.push('no microSD slot');
} else if (data.io && Object.prototype.hasOwnProperty.call(data.io, 'sd_card')) {
  pwmSummaryParts.push('microSD slot unspecified');
}
const pwmSummary = pwmSummaryParts.join(' â€¢ ');

const sumSensorCount = (list?: Array<{ count?: number }>) =>
  list?.reduce((total, entry) => total + (typeof entry.count === 'number' ? entry.count : 1), 0) ?? 0;

const imuCount = sumSensorCount(data.sensors?.imu);
const barometerCount = sumSensorCount(data.sensors?.barometer);
const magnetometerCount = sumSensorCount(data.sensors?.magnetometer);

const sensorSummaryParts: string[] = [];
if (imuCount > 0) sensorSummaryParts.push(`${imuCount}Ã— IMU`);
if (barometerCount > 0) sensorSummaryParts.push(`${barometerCount}Ã— Barometer`);
if (magnetometerCount > 0) sensorSummaryParts.push(`${magnetometerCount}Ã— Magnetometer`);
const sensorSummary =
  sensorSummaryParts.length > 0 ? sensorSummaryParts.join(' â€¢ ') : 'No onboard sensors catalogued';

const basePower = data.power ?? {};
const powerVoltageIn =
  typeof basePower.voltage_in === 'string' ? basePower.voltage_in.trim() : null;
const powerInputCount = Array.isArray(basePower.inputs) ? basePower.inputs.length : null;
const powerRedundancyLabel =
  basePower.redundant === true
    ? 'Redundant'
    : basePower.redundant === false
      ? 'Single feed'
      : null;

let powerSummary = powerVoltageIn ?? '';
const primaryPowerInput = data.power.inputs?.[0];
if (!powerSummary && primaryPowerInput) {
  const voltageDescription = formatVoltageRange(primaryPowerInput.voltage);
  const typeLabel = getPowerTypeLabel(primaryPowerInput.type);
  const combined = [voltageDescription, typeLabel].filter(Boolean).join(' â€¢ ');
  powerSummary = combined || primaryPowerInput.notes || '';
}
if (!powerSummary && data.power.notes) {
  powerSummary = data.power.notes;
}
powerSummary = powerSummary || 'See detailed power specifications';

const severityStyles = {
  info: { label: 'Info', className: 'bg-sky-500/10 text-sky-600 border-sky-500/20' },
  low: { label: 'Low', className: 'bg-emerald-500/10 text-emerald-600 border-emerald-500/30' },
  medium: { label: 'Medium', className: 'bg-amber-500/10 text-amber-600 border-amber-500/30' },
  high: { label: 'High', className: 'bg-rose-500/10 text-rose-500 border-rose-500/30' },
  critical: { label: 'Critical', className: 'bg-red-600/10 text-red-600 border-red-600/30' },
} as const;

const sensorCategoryLabels = {
  imu: 'IMU',
  barometer: 'Barometer',
  magnetometer: 'Magnetometer',
} as const;

type SeverityKey = keyof typeof severityStyles;
type IssueOrigin =
  | { type: 'controller' }
  | {
      type: 'sensor';
      sensorId: string;
      sensorName: string;
      sensorCategory: keyof typeof sensorCategoryLabels;
    };

type DisplayIssue = KnownIssue & {
  severityKey: SeverityKey;
  severityMeta: (typeof severityStyles)[SeverityKey];
  sourceTitle: string;
  sourceUrl: string | null;
  displayDate: string | null;
  origin: IssueOrigin;
};

const resolveIssue = (issue: KnownIssue, origin: IssueOrigin): DisplayIssue => {
  const severityKey: SeverityKey =
    issue.severity in severityStyles ? (issue.severity as SeverityKey) : 'medium';
  const severityMeta = severityStyles[severityKey];
  const sourceEntry = sourcesMap.get(issue.source) ?? null;
  const sourceTitle = sourceEntry?.data.title ?? issue.source;
  const sourceUrl = issue.url ?? sourceEntry?.data.url ?? null;
  let displayDate: string | null = null;
  if (issue.date) {
    const parsed = new Date(issue.date);
    displayDate = Number.isNaN(parsed.valueOf())
      ? issue.date
      : parsed.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
        });
  }

  return {
    ...issue,
    severityKey,
    severityMeta,
    sourceTitle,
    sourceUrl,
    displayDate,
    origin,
  };
};

const variantIssueBuckets = revisionVariantsWithSensors.map((variant) => {
  const seen = new Set<string>();
  const issues: DisplayIssue[] = [];

  const addIssue = (issue: KnownIssue, origin: IssueOrigin) => {
    const dedupeKey = [
      origin.type,
      origin.type === 'sensor'
        ? `${origin.sensorId}:${origin.sensorCategory}`
        : 'controller',
      issue.id ?? issue.title,
      issue.date,
    ].join('|');

    if (seen.has(dedupeKey)) {
      return;
    }

    seen.add(dedupeKey);
    issues.push(resolveIssue(issue, origin));
  };

  (variant.spec.known_issues ?? []).forEach((issue) => {
    addIssue(issue, { type: 'controller' });
  });

  (['imu', 'barometer', 'magnetometer'] as const).forEach((category) => {
    variant.spec.sensors?.[category]?.forEach((sensor) => {
      const metadata = registerSensorMetadata(sensor.id);
      const sensorIssues = metadata.issues ?? [];
      sensorIssues.forEach((sensorIssue) => {
        addIssue(sensorIssue, {
          type: 'sensor',
          sensorId: sensor.id,
          sensorName: metadata.name,
          sensorCategory: category,
        });
      });
    });
  });

  issues.sort((a, b) => (a.date > b.date ? -1 : a.date < b.date ? 1 : 0));

  return {
    id: variant.id,
    label: variant.label,
    issues,
  };
});

type ResolvedLink = { url: string; label: string | null; description: string | null } | null;
const resolveLinkEntry = (entry: unknown): ResolvedLink => {
  if (!entry) return null;
  if (typeof entry === 'string') {
    return { url: entry, label: null, description: null };
  }
  if (typeof entry === 'object' && entry !== null && 'url' in entry) {
    const { url, label, description } = entry as {
      url: string;
      label?: string | null;
      description?: string | null;
    };
    return { url, label: label ?? null, description: description ?? null };
  }

  return null;
};

const controllerLinks = {
  docs: resolveLinkEntry(data.links?.docs),
  pinout: resolveLinkEntry(data.links?.pinout),
  vendor: resolveLinkEntry(data.links?.vendor),
  github: resolveLinkEntry(data.links?.github),
};

const portTypeMetaMap: Record<string, { icon: string; className: string }> = {
  uart: {
    icon: 'ðŸ”µ',
    className:
      'border border-sky-500/30 bg-sky-500/10 text-sky-700 dark:border-sky-400/30 dark:text-sky-300',
  },
  i2c: {
    icon: 'ðŸŸ¢',
    className:
      'border border-emerald-500/30 bg-emerald-500/10 text-emerald-700 dark:border-emerald-400/30 dark:text-emerald-300',
  },
  can: {
    icon: 'ðŸŸ£',
    className:
      'border border-purple-500/30 bg-purple-500/10 text-purple-700 dark:border-purple-400/30 dark:text-purple-300',
  },
  power: {
    icon: 'ðŸŸ ',
    className:
      'border border-orange-500/30 bg-orange-500/10 text-orange-700 dark:border-orange-400/30 dark:text-orange-300',
  },
  usb: {
    icon: 'âšª',
    className:
      'border border-zinc-500/30 bg-zinc-500/10 text-zinc-700 dark:border-zinc-400/30 dark:text-zinc-300',
  },
  ethernet: {
    icon: 'ðŸŒ',
    className:
      'border border-blue-500/30 bg-blue-500/10 text-blue-700 dark:border-blue-400/30 dark:text-blue-300',
  },
  pwm: {
    icon: 'ðŸŽ›ï¸',
    className:
      'border border-amber-500/30 bg-amber-500/10 text-amber-700 dark:border-amber-400/30 dark:text-amber-300',
  },
  spi: {
    icon: 'ðŸ§¿',
    className:
      'border border-pink-500/30 bg-pink-500/10 text-pink-700 dark:border-pink-400/30 dark:text-pink-300',
  },
  rc: {
    icon: 'ðŸŽ®',
    className:
      'border border-indigo-500/30 bg-indigo-500/10 text-indigo-700 dark:border-indigo-400/30 dark:text-indigo-300',
  },
  gps: {
    icon: 'ðŸ§­',
    className:
      'border border-sky-500/30 bg-sky-500/10 text-sky-700 dark:border-sky-400/30 dark:text-sky-300',
  },
  analog: {
    icon: 'ðŸ“ˆ',
    className:
      'border border-lime-500/30 bg-lime-500/10 text-lime-700 dark:border-lime-400/30 dark:text-lime-300',
  },
  debug: {
    icon: 'ðŸ› ï¸',
    className:
      'border border-slate-500/30 bg-slate-500/10 text-slate-700 dark:border-slate-400/30 dark:text-slate-300',
  },
  other: {
    icon: 'âš™ï¸',
    className: 'border border-black/10 bg-muted/50 text-muted-foreground dark:border-white/10',
  },
};

const getPortTypeMeta = (type?: string) => {
  if (!type) return portTypeMetaMap.other;
  const normalized = type.toLowerCase();
  return portTypeMetaMap[normalized] ?? portTypeMetaMap.other;
};

type LinkItem = {
  key: string;
  label: string;
  description: string;
  href: string;
  icon: typeof BookOpen;
};

const linkItems: LinkItem[] = [];

if (controllerLinks.docs?.url) {
  linkItems.push({
    key: 'docs',
    label: controllerLinks.docs.label ?? 'Documentation',
    description:
      controllerLinks.docs.description ?? 'Official setup guides and reference manuals.',
    href: controllerLinks.docs.url,
    icon: BookOpen,
  });
}

if (controllerLinks.pinout?.url) {
  linkItems.push({
    key: 'pinout',
    label: controllerLinks.pinout.label ?? 'Pinout Diagram',
    description:
      controllerLinks.pinout.description ?? 'Connector maps and wiring references.',
    href: controllerLinks.pinout.url,
    icon: CircuitBoard,
  });
}

if (controllerLinks.vendor?.url) {
  linkItems.push({
    key: 'vendor',
    label: controllerLinks.vendor.label ?? 'Vendor Page',
    description:
      controllerLinks.vendor.description ?? 'Official product listings and purchasing options.',
    href: controllerLinks.vendor.url,
    icon: Store,
  });
}

if (controllerLinks.github?.url) {
  linkItems.push({
    key: 'github',
    label: controllerLinks.github.label ?? 'GitHub Repository',
    description:
      controllerLinks.github.description ?? 'Hardware design files or firmware resources.',
    href: controllerLinks.github.url,
    icon: Github,
  });
}

if (editUrl) {
  linkItems.push({
    key: 'edit',
    label: 'Edit on GitHub',
    description: 'Propose improvements to this controller entry.',
    href: editUrl,
    icon: Pencil,
  });
}

const hasLinkItems = linkItems.length > 0;
---

<DetailPageLayout
  title={pageTitle}
  description={pageDescription}
  editPath={editPath}
  breadcrumbs={[
    { href: `${basePath}/`, label: 'Home' },
    { href: `${basePath}/controllers`, label: 'Controllers' },
    { label: data.title },
  ]}
>
  <Fragment slot="head">
    <link rel="canonical" href={canonicalUrl} />
    <meta property="og:title" content={ogTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:type" content="product" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={ogImageUrl} />
    <meta property="og:image:alt" content={ogImageAlt} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:site_name" content="FCBase" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={ogTitle} />
    <meta name="twitter:description" content={pageDescription} />
    <meta name="twitter:image" content={ogImageUrl} />
    <meta name="twitter:image:alt" content={ogImageAlt} />
    <script type="application/ld+json" is:inline>{productLdJson}</script>
  </Fragment>
  <DetailHeader
    slot="header"
    title={data.title}
    subtitle={`by ${manufacturerName}`}
    description={data.notes}
    compareId={controller.id}
    compareType="controller"
  >
    <StatusBadge 
      slot="badges" 
      variant="verification" 
      status={data.verification.level}
      showIcon
      size="sm"
    />
    <StatusBadge 
      slot="badges" 
      variant="hardware" 
      status={data.hardware.openness}
      size="sm"
    >
      {data.hardware.openness.charAt(0).toUpperCase() + data.hardware.openness.slice(1)} Hardware
    </StatusBadge>
  </DetailHeader>

  <!-- Hero Split-Screen Banner -->
  {previewImage && (
    <div class="relative w-full mb-8 overflow-hidden rounded-xl border border-border shadow-lg bg-background">
      <div class="grid grid-cols-1 lg:grid-cols-5 gap-0">
        <!-- Image Section - 60% width on desktop -->
        <div class="lg:col-span-3 bg-gradient-to-br from-muted/50 via-background to-muted/30 p-8 lg:p-12 flex items-center justify-center">
          <div class="relative w-full max-h-[400px] flex items-center justify-center">
            {heroImage ? (
              <Picture
                src={heroImage}
                widths={[320, 640, 960]}
                formats={["avif", "webp"]}
                sizes={heroSizes}
                alt={heroAlt}
                loading="lazy"
                decoding="async"
                pictureClass="w-full h-full"
                imgClass="w-full h-full object-contain max-h-[400px]"
              />
            ) : remotePreview ? (
              <img
                src={remotePreview.src}
                alt={heroAlt}
                loading="lazy"
                decoding="async"
                width={remotePreview.width}
                height={remotePreview.height}
                class="w-full h-full object-contain max-h-[400px]"
              />
            ) : (
              <div class="flex h-full w-full items-center justify-center text-sm font-medium text-muted-foreground min-h-[300px]">
                {heroAlt}
              </div>
            )}
          </div>
        </div>

        <!-- Quick Specs Section - 40% width on desktop -->
        <div class="lg:col-span-2 bg-muted/20 p-6 lg:p-8 border-t lg:border-t-0 lg:border-l border-border/40">
          <div class="space-y-6">
            <div>
              <h3 class="text-sm uppercase tracking-wide font-bold text-foreground mb-4 pb-2 border-b border-border/40">Key Specifications</h3>
              <div class="space-y-4">
                {/* MCU */}
                <SpecItem icon={Cpu} label="MCU" iconClass="text-muted-foreground">
                  <div slot="value" class="flex flex-wrap items-center gap-2">
                    {mcu?.id ? (
                      <a
                        href={`${basePath}/mcu/${mcu.id}`}
                        class="text-primary hover:underline font-semibold"
                      >
                        {mcuName}
                      </a>
                    ) : (
                      <span>{mcuName ?? 'â€”'}</span>
                    )}
                    {mcuResourceLinks.length > 0 && (
                      <ResourceLinkList links={mcuResourceLinks} size="xs" class="gap-1.5" />
                    )}
                  </div>
                </SpecItem>
                
                {/* Mounting */}
                <SpecItem 
                  icon={Package} 
                  label="Mounting Pattern" 
                  value={formattedMounting}
                  iconClass="text-muted-foreground"
                />
                
                {/* I/O Summary */}
                {ioSummary !== 'â€”' && (
                  <SpecItem
                    icon={Cable}
                    label="Connectivity"
                    value={ioSummary}
                    iconClass="text-muted-foreground"
                  />
                )}

                {/* Power */}
                <SpecItem
                  icon={Zap}
                  label="Power"
                  value={powerSummary}
                  iconClass="text-muted-foreground"
                />

                {/* Sensors Summary */}
                <SpecItem
                  icon={Layers}
                  label="Onboard Sensors"
                  value={sensorSummary}
                  iconClass="text-muted-foreground"
                />
              </div>
            </div>

            {/* Firmware Support Badges */}
            {firmware.length > 0 && (
              <div class="pt-4 border-t border-border/40">
                <div class="text-xs uppercase tracking-wide font-semibold text-muted-foreground mb-3">
                  Firmware Support
                </div>
                <div class="flex flex-wrap gap-2">
                  {firmware.map((fw) => {
                    const badge = (
                      <StatusBadge variant="firmware" status={fw.status} size="sm">
                        {fw.name}
                      </StatusBadge>
                    );

                    return fw.docUrl ? (
                      <a
                        href={fw.docUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="inline-flex"
                        key={fw.id}
                        title={`Open ${fw.name} hardware documentation`}
                      >
                        {badge}
                      </a>
                    ) : (
                      <span key={fw.id} class="inline-flex">
                        {badge}
                      </span>
                    );
                  })}
                </div>
              </div>
            )}

            {controllerResourceLinks.length > 0 && (
              <div class="pt-4 border-t border-border/40">
                <div class="text-xs uppercase tracking-wide font-semibold text-muted-foreground mb-3">
                  Reference Docs
                </div>
                <ResourceLinkList links={controllerResourceLinks} size="sm" class="gap-2" />
              </div>
            )}

            {/* Image Credit */}
            {previewImage.credit && (
              <div class="pt-4 border-t border-border/40">
                {previewImage.sourceUrl ? (
                  <a
                    href={previewImage.sourceUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-xs text-muted-foreground hover:text-foreground transition-colors inline-flex items-center gap-1.5"
                  >
                    <span>Image: {previewImage.credit}</span>
                    <span class="text-primary">â†—</span>
                  </a>
                ) : (
                  <span class="text-xs text-muted-foreground">
                    Image: {previewImage.credit}
                  </span>
                )}
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  )}

  <nav
    aria-label="Contents"
    class="mt-10 rounded-lg border border-border/60 bg-muted/40 p-4"
  >
    <h2 class="text-xs font-semibold uppercase tracking-wide text-muted-foreground">
      Contents
    </h2>
    <ul class="mt-3 flex flex-wrap gap-2">
      <li>
        <a
          href="#hardware-overview"
          class="inline-flex items-center justify-center rounded-md border border-transparent bg-background px-3 py-1.5 text-xs font-semibold uppercase tracking-wide text-foreground shadow-xs transition focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background"
        >
          Hardware
        </a>
      </li>
      <li>
        <a
          href="#power-supply"
          class="inline-flex items-center justify-center rounded-md border border-transparent bg-background px-3 py-1.5 text-xs font-semibold uppercase tracking-wide text-foreground shadow-xs transition focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background"
        >
          Power
        </a>
      </li>
      <li>
        <a
          href="#connectivity"
          class="inline-flex items-center justify-center rounded-md border border-transparent bg-background px-3 py-1.5 text-xs font-semibold uppercase tracking-wide text-foreground shadow-xs transition focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background"
        >
          Connectivity
        </a>
      </li>
      <li>
        <a
          href="#sensors"
          class="inline-flex items-center justify-center rounded-md border border-transparent bg-background px-3 py-1.5 text-xs font-semibold uppercase tracking-wide text-foreground shadow-xs transition focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background"
        >
          Sensors
        </a>
      </li>
      {data.features && data.features.length > 0 && (
        <li>
          <a
            href="#features"
            class="inline-flex items-center justify-center rounded-md border border-transparent bg-background px-3 py-1.5 text-xs font-semibold uppercase tracking-wide text-foreground shadow-xs transition focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background"
          >
            Features
          </a>
        </li>
      )}
      <li>
        <a
          href="#known-issues"
          class="inline-flex items-center justify-center rounded-md border border-transparent bg-background px-3 py-1.5 text-xs font-semibold uppercase tracking-wide text-foreground shadow-xs transition focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background"
        >
          Known Issues
        </a>
      </li>
      <li>
        <a
          href="#resources"
          class="inline-flex items-center justify-center rounded-md border border-transparent bg-background px-3 py-1.5 text-xs font-semibold uppercase tracking-wide text-foreground shadow-xs transition focus-visible:outline-hidden focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background"
        >
          Documentation & Vendors
        </a>
      </li>
    </ul>
  </nav>

  <section id="specs" aria-labelledby="controller-specifications" class="mt-10 space-y-6">
    <h2 class="text-lg font-semibold tracking-tight text-foreground" id="controller-specifications">
      Detailed Specifications
    </h2>
      <Card className="border border-border/60 bg-background/80 shadow-xs">
        <CardHeader className="pb-4">
          <CardTitle className="text-base font-semibold">Core Specifications</CardTitle>
          <CardDescription>
            Quick reference for the primary hardware capabilities.
          </CardDescription>
        </CardHeader>
        <CardContent className="pt-0">
          <ProfessionalTable class="text-sm">
            <tbody>
              <TableRow2Col
                label1="MCU"
                label2="Mounting"
                value2={formattedMounting}
                mono1
                mono2
              >
                <Fragment slot="value1">
                  <div class="flex flex-wrap items-center gap-2">
                    {mcu?.id ? (
                      <a
                        href={`${basePath}/mcu/${mcu.id}`}
                        class="text-primary hover:underline font-semibold"
                      >
                        {mcuName}
                      </a>
                    ) : (
                      <span>{mcuName ?? 'â€”'}</span>
                    )}
                    {mcuResourceLinks.length > 0 && (
                      <ResourceLinkList links={mcuResourceLinks} size="xs" class="gap-1.5" />
                    )}
                  </div>
                </Fragment>
              </TableRow2Col>
              <TableRow2Col
                label1="Power"
                value1={powerSummary}
                label2="I/O Overview"
                value2={ioSummary}
              />
              <TableRow2Col
                label1="PWM & Storage"
                value1={pwmSummary}
                label2="Sensors"
                value2={sensorSummary}
              />
            </tbody>
          </ProfessionalTable>
        </CardContent>
      </Card>

      <div class="grid grid-cols-1 gap-4 lg:grid-cols-4">
        <div class="space-y-6 lg:col-span-3">
          <div
            class="space-y-6"
            data-revision-root
            data-default-variant={defaultVariantId}
          >
            {hasMultipleVariants && (
              <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                <div class="sm:hidden w-full space-y-1">
                  <label
                    for="hardware-revision-select"
                    class="text-[10px] uppercase tracking-wide font-semibold text-muted-foreground"
                  >
                    Hardware revision
                  </label>
                  <select
                    id="hardware-revision-select"
                    data-revision-select
                    class="w-full rounded-sm border border-border/60 bg-background px-3 py-2 text-sm text-foreground focus:outline-hidden focus:ring-2 focus:ring-primary/40"
                  >
                    {revisionVariantsWithSensors.map((variant) => (
                      <option value={variant.id}>{variant.label}</option>
                    ))}
                  </select>
                </div>
                <div
                  class="hidden sm:flex flex-wrap gap-2"
                  role="tablist"
                  aria-label="Hardware revisions"
                >
                  {revisionVariantsWithSensors.map((variant, idx) => (
                    <button
                      type="button"
                      data-revision-tab={variant.id}
                      class={`border rounded-sm px-3 py-1.5 text-sm font-medium transition-colors ${idx === 0 ? 'bg-primary/10 border-primary/40 text-primary' : 'bg-muted/30 border-border/60 text-muted-foreground'}`}
                      aria-selected={idx === 0 ? 'true' : 'false'}
                    >
                      {variant.label}
                    </button>
                  ))}
                </div>
              </div>
            )}

            <section id="hardware-overview" aria-labelledby="hardware-overview-heading">
              <Card className="border border-border/60 bg-background/80 shadow-xs">
                <CardHeader className="pb-4">
                  <h3 class="text-base font-semibold text-foreground" id="hardware-overview-heading">
                    Hardware Overview
                  </h3>
                  <p class="text-sm text-muted-foreground">
                    Core MCU, mounting, and mechanical data.
                  </p>
                </CardHeader>
                <CardContent className="space-y-6">
                  {revisionVariantsWithSensors.map((variant, idx) => {
                    const dimensions = variant.spec.dimensions ?? data.dimensions;
                    const variantMcuLabel =
                      variant.spec.mcu && variant.spec.mcu !== data.mcu ? variant.spec.mcu : mcuName;

                    return (
                      <div
                        key={`${variant.id}-hardware`}
                        data-revision-panel={variant.id}
                        class={`space-y-4 ${idx === 0 ? '' : 'hidden'}`}
                        aria-hidden={idx === 0 ? 'false' : 'true'}
                      >
                        {variant.revision ? (
                          <div class="rounded-sm border border-border/40 bg-muted/30 p-3 space-y-2">
                            <div class="flex flex-wrap items-center justify-between gap-2">
                              <div class="flex flex-wrap items-center gap-2">
                                <Badge className="text-[10px] uppercase tracking-wide bg-primary/10 text-primary border-primary/20">
                                  {variant.label}
                                </Badge>
                                {variant.revision.released && (
                                  <span class="text-xs font-mono text-muted-foreground">
                                    {variant.revision.released}
                                  </span>
                                )}
                              </div>
                              <span class="text-xs font-semibold text-muted-foreground">
                                Revision overview
                              </span>
                            </div>
                            {variant.revision.notes && (
                              <p class="text-xs leading-snug text-muted-foreground">
                                {variant.revision.notes}
                              </p>
                            )}
                            {variant.revision.changes && variant.revision.changes.length > 0 && (
                              <ul class="space-y-1">
                                {variant.revision.changes.map((change, changeIdx) => (
                                  <li
                                    key={`${variant.id}-change-${changeIdx}`}
                                    class="flex items-start gap-2 text-xs text-muted-foreground"
                                  >
                                    <span class="text-primary font-bold mt-0.5">â€¢</span>
                                    <span class="leading-snug text-foreground">{change}</span>
                                  </li>
                                ))}
                              </ul>
                            )}
                            {variant.revision.overrides && (
                              <div class="flex flex-wrap gap-1.5">
                                {variant.revision.overrides.sensors && (
                                  <Badge className="text-[10px] uppercase tracking-wide bg-purple-500/10 text-purple-500 border-purple-500/30">
                                    Sensor overrides
                                  </Badge>
                                )}
                                {variant.revision.overrides.io && (
                                  <Badge className="text-[10px] uppercase tracking-wide bg-blue-500/10 text-blue-500 border-blue-500/30">
                                    I/O overrides
                                  </Badge>
                                )}
                                {variant.revision.overrides.power && (
                                  <Badge className="text-[10px] uppercase tracking-wide bg-amber-500/10 text-amber-500 border-amber-500/30">
                                    Power overrides
                                  </Badge>
                                )}
                              </div>
                            )}
                            {variant.sourceEntries.length > 0 && (
                              <div class="flex flex-wrap gap-1.5">
                                {variant.sourceEntries.map((source) =>
                                  source.url ? (
                                    <a
                                      key={source.id}
                                      href={source.url}
                                      target="_blank"
                                      rel="noopener noreferrer"
                                      class="text-[10px] uppercase tracking-wide font-semibold inline-flex items-center gap-1 rounded-sm border border-primary/30 bg-primary/5 px-2 py-1 text-primary hover:bg-primary/10 transition-colors"
                                    >
                                      {source.title}
                                      <span>â†—</span>
                                    </a>
                                  ) : (
                                    <span
                                      key={source.id}
                                      class="text-[10px] uppercase tracking-wide font-semibold inline-flex items-center gap-1 rounded-sm border border-border/40 bg-muted/30 px-2 py-1 text-muted-foreground"
                                    >
                                      {source.title}
                                    </span>
                                  )
                                )}
                              </div>
                            )}
                          </div>
                        ) : (
                          <div class="rounded-sm border border-border/40 bg-muted/20 p-3 space-y-2">
                            <div class="flex flex-wrap items-center justify-between gap-2">
                              <span class="text-sm font-semibold text-foreground">
                                Base hardware specification
                              </span>
                              <Badge className="text-[10px] uppercase tracking-wide bg-primary/10 text-primary border-primary/20">
                                Default
                              </Badge>
                            </div>
                            {data.hardware.notes && (
                              <p class="text-xs leading-snug text-muted-foreground">{data.hardware.notes}</p>
                            )}
                          </div>
                        )}
                        <ProfessionalTable class="text-sm">
                          <tbody>
                            <TableRow2Col
                              label1="MCU"
                              label2="Mounting"
                              value2={formatMounting(variant.spec.mounting ?? data.mounting)}
                              mono1
                              mono2
                            >
                              <Fragment slot="value1">
                                <div class="flex flex-wrap items-center gap-2">
                                  {(!variant.spec.mcu || variant.spec.mcu === data.mcu) && mcu?.id ? (
                                    <a
                                      href={`${basePath}/mcu/${mcu.id}`}
                                      class="text-primary hover:underline font-semibold"
                                    >
                                      {variantMcuLabel}
                                    </a>
                                  ) : (
                                    <span>{variantMcuLabel}</span>
                                  )}
                                  {(!variant.spec.mcu || variant.spec.mcu === data.mcu) &&
                                    mcuResourceLinks.length > 0 && (
                                      <ResourceLinkList
                                        links={mcuResourceLinks}
                                        size="xs"
                                        class="gap-1.5"
                                      />
                                    )}
                                </div>
                              </Fragment>
                            </TableRow2Col>
                            {dimensions && (
                              <TableRow2Col
                                label1="Dimensions"
                                value1={formatDimensions(dimensions)}
                                label2="Weight"
                                value2={formatWeight(dimensions.weight_g) || 'â€”'}
                                mono1
                                mono2
                              />
                            )}
                          </tbody>
                        </ProfessionalTable>
                      </div>
                    );
                  })}
                </CardContent>
              </Card>
            </section>

            <section id="power-supply" aria-labelledby="power-supply-heading">
              <Card className="border border-border/60 bg-background/80 shadow-xs">
                <CardHeader className="pb-4">
                  <h3 class="text-base font-semibold text-foreground" id="power-supply-heading">
                    Power Supply
                  </h3>
                  <p class="text-sm text-muted-foreground">
                    Input rails, regulators, and redundancy.
                  </p>
                  <div class="mt-3 flex flex-wrap items-center gap-2">
                    <PowerSummaryBadge label="Voltage" value={powerVoltageIn} />
                    <PowerSummaryBadge label="Inputs" value={powerInputCount} />
                    <PowerSummaryBadge label="Redundancy" value={powerRedundancyLabel} />
                  </div>
                </CardHeader>
                <CardContent className="space-y-6">
                  {revisionVariantsWithSensors.map((variant, idx) => {
                    const power = variant.spec.power ?? data.power;
                    const inputs = power?.inputs ?? [];
                    const hasInputs = Array.isArray(inputs) && inputs.length > 0;

                    return (
                      <div
                        key={`${variant.id}-power`}
                        data-revision-panel={variant.id}
                        class={`space-y-4 ${idx === 0 ? '' : 'hidden'}`}
                        aria-hidden={idx === 0 ? 'false' : 'true'}
                      >
                        {hasInputs && (
                          <div class="space-y-3">
                            <h4 class="text-sm font-semibold text-foreground">Power Inputs</h4>
                            <div class="grid gap-3 md:grid-cols-2">
                              {inputs.map((input, inputIdx) => {
                                const voltageLabel = formatVoltageRange(input.voltage);
                                const typeLabel = getPowerTypeLabel(input.type);
                                return (
                                  <div
                                    key={`${input.name ?? 'input'}-${inputIdx}`}
                                    class="rounded-sm border border-border/40 bg-muted/20 p-3 space-y-1"
                                  >
                                    <div class="flex flex-wrap items-center justify-between gap-2">
                                      <span class="font-mono font-semibold text-sm text-foreground">
                                        {input.name ?? `Input ${inputIdx + 1}`}
                                      </span>
                                      {typeLabel && (
                                        <span class="text-[10px] uppercase tracking-wide text-muted-foreground">
                                          {typeLabel}
                                        </span>
                                      )}
                                    </div>
                                    {input.connector && (
                                      <div class="text-xs text-muted-foreground">
                                        Connector:&nbsp;
                                        <span class="font-mono text-foreground">{input.connector}</span>
                                      </div>
                                    )}
                                    {voltageLabel && (
                                      <div class="text-xs text-muted-foreground">
                                        Voltage:&nbsp;
                                        <span class="font-semibold text-foreground">{voltageLabel}</span>
                                      </div>
                                    )}
                                    {input.notes && (
                                      <p class="text-xs leading-snug text-muted-foreground">{input.notes}</p>
                                    )}
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        )}
                        <ProfessionalTable class="text-sm">
                          <tbody>
                            <TableRow2Col
                              label1="Input Voltage"
                              value1={power?.voltage_in ?? 'â€”'}
                              label2="Redundancy"
                              value2={power?.redundant ? 'âœ“ Yes' : 'â€”'}
                              mono1
                            />
                          </tbody>
                        </ProfessionalTable>
                        {power?.notes && (
                          <p class="text-sm leading-relaxed text-muted-foreground">{power.notes}</p>
                        )}
                      </div>
                    );
                  })}
                </CardContent>
              </Card>
            </section>

            <section id="connectivity" aria-labelledby="connectivity-heading">
              <Card className="border border-border/60 bg-background/80 shadow-xs">
                <CardHeader className="pb-4">
                  <h3 class="text-base font-semibold text-foreground" id="connectivity-heading">
                    Connectivity & I/O
                  </h3>
                  <p class="text-sm text-muted-foreground">
                    Port availability, buses, and expansion options.
                  </p>
                </CardHeader>
                <CardContent className="space-y-6">
                  {revisionVariantsWithSensors.map((variant, idx) => {
                    const io = variant.spec.io ?? data.io;
                    const peripheralPorts = variant.spec.peripheral_ports ?? [];
                    const legacyPeripherals = io?.peripherals ?? [];
                    const hasPeripheralPorts = Array.isArray(peripheralPorts) && peripheralPorts.length > 0;
                    const hasLegacyPeripherals = Array.isArray(legacyPeripherals) && legacyPeripherals.length > 0;

                    return (
                      <div
                        key={`${variant.id}-io`}
                        data-revision-panel={variant.id}
                        class={`space-y-4 ${idx === 0 ? '' : 'hidden'}`}
                        aria-hidden={idx === 0 ? 'false' : 'true'}
                      >
                        <ProfessionalTable class="text-sm">
                          <tbody>
                            <TableRow2Col
                              label1="UARTs"
                              value1={io?.uarts ?? 'â€”'}
                              label2="CAN Bus"
                              value2={io?.can ?? 'â€”'}
                            />
                            <TableRow2Col
                              label1="PWM Outputs"
                              value1={io?.pwm ?? 'â€”'}
                              label2="SD Card"
                              value2={io?.sd_card === undefined ? 'â€”' : io.sd_card ? 'âœ“ Yes' : 'âœ— No'}
                            />
                            {io?.ethernet !== undefined && (
                              <TableRow label="Ethernet" value={io.ethernet ? 'âœ“ Yes' : 'âœ— No'} />
                            )}
                          </tbody>
                        </ProfessionalTable>

                        {hasPeripheralPorts && (
                          <div class="space-y-3">
                            <div class="flex flex-wrap items-center justify-between gap-3">
                              <h4 class="text-sm font-semibold text-foreground">Peripheral Ports</h4>
                              {controllerLinks.pinout?.url && (
                                <a
                                  class={cn(
                                    buttonVariants({ variant: 'secondary', size: 'sm' }),
                                    'shrink-0'
                                  )}
                                  href={controllerLinks.pinout.url}
                                  target="_blank"
                                  rel="noreferrer noopener"
                                >
                                  View Pinout
                                </a>
                              )}
                            </div>
                            <div class="overflow-x-auto rounded-sm border border-black/10 bg-background/60 dark:border-white/10">
                              <table class="w-full table-auto text-sm">
                                <thead class="bg-muted/50 text-xs uppercase tracking-wide text-muted-foreground">
                                  <tr>
                                    <th class="px-3 py-2 text-left font-semibold">Port</th>
                                    <th class="px-3 py-2 text-left font-semibold">Type</th>
                                    <th class="px-3 py-2 text-left font-semibold">Default Function</th>
                                    <th class="px-3 py-2 text-left font-semibold">Voltage / Level</th>
                                    <th class="px-3 py-2 text-left font-semibold">Connector</th>
                                    <th class="px-3 py-2 text-left font-semibold">Notes</th>
                                  </tr>
                                </thead>
                                <tbody class="[&>tr:not(:first-child)]:border-t [&>tr:not(:first-child)]:border-black/5 dark:[&>tr:not(:first-child)]:border-white/10">
                                  {peripheralPorts.map((port) => {
                                    const typeMeta = getPortTypeMeta(port.type);
                                    const typeLabel = port.type ? formatPeripheralType(port.type) : 'â€”';
                                    return (
                                      <tr
                                        class="hover:bg-muted/40 transition-colors"
                                        key={`${port.port}-${port.type ?? 'unknown'}`}
                                        title={port.notes ?? undefined}
                                      >
                                        <td class="px-3 py-2 font-semibold text-foreground">
                                          <span class="inline-flex items-center gap-2">
                                            {port.port}
                                            {port.notes && (
                                              <span class="text-muted-foreground" aria-hidden="true">â“˜</span>
                                            )}
                                          </span>
                                        </td>
                                        <td class="px-3 py-2">
                                          <span
                                            class={cn(
                                              'inline-flex items-center gap-1 rounded-full px-2.5 py-1 text-xs font-semibold',
                                              typeMeta.className
                                            )}
                                          >
                                            <span aria-hidden="true">{typeMeta.icon}</span>
                                            <span>{typeLabel}</span>
                                          </span>
                                        </td>
                                        <td class="px-3 py-2 text-sm text-foreground/90">
                                          {port.default_use ?? 'â€”'}
                                        </td>
                                        <td class="px-3 py-2 text-sm text-foreground/90">
                                          {port.voltage ?? 'â€”'}
                                        </td>
                                        <td class="px-3 py-2 text-sm text-foreground/90">
                                          {port.connector ?? 'â€”'}
                                        </td>
                                        <td class="px-3 py-2 text-sm text-muted-foreground">
                                          {port.notes ?? 'â€”'}
                                        </td>
                                      </tr>
                                    );
                                  })}
                                </tbody>
                              </table>
                            </div>
                          </div>
                        )}

                        {!hasPeripheralPorts && hasLegacyPeripherals && (
                          <div class="space-y-3">
                            <h4 class="text-sm font-semibold text-foreground">Peripheral Ports</h4>
                            <div class="grid gap-3 sm:grid-cols-2">
                              {legacyPeripherals.map((peripheral, idx) => {
                                const interfaceBadges = normalizePeripheralInterfaces(peripheral.interfaces);
                                return (
                                  <div
                                    class="rounded-sm border border-border/40 bg-background/70 p-3 shadow-xs"
                                    key={`${peripheral.name}-${idx}`}
                                  >
                                    <div class="flex items-center justify-between gap-2">
                                      <span class="text-sm font-semibold text-foreground">
                                        {peripheral.name}
                                        {peripheral.count && (
                                          <span class="ml-1 text-xs font-medium text-muted-foreground">Ã—{peripheral.count}</span>
                                        )}
                                      </span>
                                      <Badge className="text-[10px] tracking-wide font-medium">
                                        {formatPeripheralType(peripheral.type)}
                                      </Badge>
                                    </div>
                                    {interfaceBadges.length > 0 && (
                                      <div class="mt-2 flex flex-wrap gap-1.5">
                                        {interfaceBadges.map(({ label, count }) => (
                                          <Badge
                                            variant="secondary"
                                            className="text-[10px] tracking-wide font-medium"
                                            key={`${peripheral.name}-${label}`}
                                          >
                                            <span>{label}</span>
                                            {count > 1 && (
                                              <span className="ml-1 text-[10px] text-muted-foreground font-semibold">Ã—{count}</span>
                                            )}
                                          </Badge>
                                        ))}
                                      </div>
                                    )}
                                    {peripheral.connector && (
                                      <p class="mt-2 text-xs text-muted-foreground">
                                        <span class="font-medium text-foreground">Connector:</span>&nbsp;{peripheral.connector}
                                      </p>
                                    )}
                                    {peripheral.voltage && (
                                      <p class="text-xs text-muted-foreground">
                                        <span class="font-medium text-foreground">Voltage:</span> {peripheral.voltage}
                                      </p>
                                    )}
                                    {peripheral.notes && (
                                      <p class="mt-1 text-xs leading-snug text-muted-foreground">{peripheral.notes}</p>
                                    )}
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </CardContent>
              </Card>
            </section>

            <section id="sensors" aria-labelledby="sensors-heading">
              <Card className="border border-border/60 bg-background/80 shadow-xs">
                <CardHeader className="pb-4">
                  <h3 class="text-base font-semibold text-foreground" id="sensors-heading">
                    Onboard Sensors
                  </h3>
                  <p class="text-sm text-muted-foreground">
                    IMU, barometer, and magnetometer load-outs per revision.
                  </p>
                </CardHeader>
                <CardContent className="space-y-6">
                  {revisionVariantsWithSensors.map((variant, idx) => {
                    const hasSensors =
                      variant.sensorDetails.imu.length > 0 ||
                      variant.sensorDetails.barometer.length > 0 ||
                      variant.sensorDetails.magnetometer.length > 0;

                    return (
                      <div
                        key={`${variant.id}-sensors`}
                        data-revision-panel={variant.id}
                        class={`space-y-4 ${idx === 0 ? '' : 'hidden'}`}
                        aria-hidden={idx === 0 ? 'false' : 'true'}
                      >
                        {hasSensors ? (
                          <ProfessionalTable class="text-sm">
                            <tbody>
                              {variant.sensorDetails.imu.length > 0 && (
                                <TableRow label="IMU">
                                  <SensorList
                                    sensors={variant.sensorDetails.imu.map((s) => ({
                                      id: s.id,
                                      name: s.name ?? s.id,
                                      instances: s.count,
                                      links: s.links,
                                    }))}
                                    linkable={true}
                                    size="sm"
                                  />
                                </TableRow>
                              )}
                              {variant.sensorDetails.barometer.length > 0 && (
                                <TableRow label="Barometer">
                                  <SensorList
                                    sensors={variant.sensorDetails.barometer.map((s) => ({
                                      id: s.id,
                                      name: s.name ?? s.id,
                                      instances: s.count,
                                      links: s.links,
                                    }))}
                                    linkable={true}
                                    size="sm"
                                  />
                                </TableRow>
                              )}
                              {variant.sensorDetails.magnetometer.length > 0 && (
                                <TableRow label="Magnetometer">
                                  <SensorList
                                    sensors={variant.sensorDetails.magnetometer.map((s) => ({
                                      id: s.id,
                                      name: s.name ?? s.id,
                                      instances: s.count,
                                      links: s.links,
                                    }))}
                                    linkable={true}
                                    size="sm"
                                  />
                                </TableRow>
                              )}
                            </tbody>
                          </ProfessionalTable>
                        ) : (
                          <p class="text-sm text-muted-foreground">
                            No onboard sensors catalogued for this revision.
                          </p>
                        )}
                      </div>
                    );
                  })}
                </CardContent>
              </Card>
            </section>

            {data.features && data.features.length > 0 && (
              <section id="features" aria-labelledby="features-heading">
                <Card className="border border-border/60 bg-background/80 shadow-xs">
                  <CardHeader className="pb-4">
                    <h3 class="text-base font-semibold text-foreground" id="features-heading">
                      Additional Features
                    </h3>
                    <p class="text-sm text-muted-foreground">
                      Value-add capabilities bundled with the controller.
                    </p>
                  </CardHeader>
                  <CardContent>
                    <ul class="grid gap-2 sm:grid-cols-2">
                      {data.features.map((feature) => (
                        <li class="flex items-start gap-2" key={feature}>
                          <span class="mt-0.5 text-sm font-bold text-emerald-600 dark:text-emerald-400">âœ“</span>
                          <span class="text-sm font-medium text-foreground">{feature}</span>
                        </li>
                      ))}
                    </ul>
                  </CardContent>
                </Card>
              </section>
            )}
          </div>

        </div>

        <aside class="space-y-4">
          <Card>
            <CardHeader>
              <CardTitle className="text-base font-bold uppercase tracking-wide text-primary">Quick Reference</CardTitle>
            </CardHeader>
            <CardContent>
              <ProfessionalTable class="text-xs">
                <TableSection title="Firmware Support" colspan={2} />
                {firmware.map((fw) => (
                  <tr class="even:bg-muted/30 hover:bg-muted/50 transition-colors" key={fw.id}>
                    <td class="px-2 py-1.5 font-semibold">{fw.name}</td>
                    <td class="px-2 py-1.5 text-right">
                      <StatusBadge
                        variant="firmware"
                        status={fw.status}
                        size="xs"
                      />
                    </td>
                  </tr>
                ))}

                <TableSection title="Information" colspan={2} />
                <tr class="even:bg-muted/30 hover:bg-muted/50 transition-colors">
                  <td class="px-2 py-1.5 text-muted-foreground font-medium">Verification</td>
                  <td class="px-2 py-1.5 text-right">
                    <StatusBadge
                      variant="verification"
                      status={data.verification.level}
                      size="xs"
                    />
                  </td>
                </tr>
                <tr class="even:bg-muted/30 hover:bg-muted/50 transition-colors">
                  <td class="px-2 py-1.5 text-muted-foreground font-medium">Hardware</td>
                  <td class="px-2 py-1.5 text-right">
                    <StatusBadge
                      variant="hardware"
                      status={data.hardware.openness}
                      size="xs"
                    />
                  </td>
                </tr>
                <tr class="even:bg-muted/30 hover:bg-muted/50 transition-colors">
                  <td class="px-2 py-1.5 text-muted-foreground font-medium">Updated</td>
                  <td class="px-2 py-1.5 font-mono font-semibold text-right">{data.verification.last_updated}</td>
                </tr>
                <tr class="even:bg-muted/30 hover:bg-muted/50 transition-colors">
                  <td class="px-2 py-1.5 text-muted-foreground font-medium">Sources</td>
                  <td class="px-2 py-1.5 font-mono font-semibold text-right">{data.sources.length}</td>
                </tr>
                {manufacturerName && (
                  <tr class="even:bg-muted/30 hover:bg-muted/50 transition-colors">
                    <td class="px-2 py-1.5 text-muted-foreground font-medium">Manufacturer</td>
                    <td class="px-2 py-1.5 text-right">
                      {manufacturerUrl ? (
                        <a
                          href={manufacturerUrl}
                          class="font-semibold hover:text-primary transition-colors text-xs inline-flex items-center gap-1"
                        >
                          {manufacturerName}
                          <span class="text-primary">â†’</span>
                        </a>
                      ) : (
                        <span class="font-semibold text-xs">{manufacturerName}</span>
                      )}
                    </td>
                  </tr>
                )}
              </ProfessionalTable>
            </CardContent>
          </Card>
          {hardwareRevisionSummaries.length > 0 && (
            <Card>
              <CardHeader>
                <CardTitle className="text-base font-bold uppercase tracking-wide text-primary">
                  Hardware Revisions
                </CardTitle>
                {data.hardware.notes && (
                  <CardDescription className="text-xs text-muted-foreground leading-relaxed">
                    {data.hardware.notes}
                  </CardDescription>
                )}
              </CardHeader>
              <CardContent>
                <div class="space-y-3">
                  {hardwareRevisionSummaries.map((variant) => {
                    const revision = variant.revision!;
                    return (
                      <div
                        key={variant.id}
                        class="rounded-sm border border-border/40 bg-background/70 p-3 shadow-xs"
                      >
                        <div class="flex flex-wrap items-center justify-between gap-2">
                          <span class="font-semibold text-sm text-foreground">{variant.label}</span>
                          {revision.released && (
                            <Badge className="text-[10px] uppercase tracking-wide bg-primary/10 text-primary border-primary/20">
                              {revision.released}
                            </Badge>
                          )}
                        </div>
                        {revision.notes && (
                          <p class="mt-1 text-xs leading-snug text-muted-foreground">{revision.notes}</p>
                        )}
                        {revision.changes && revision.changes.length > 0 && (
                          <ul class="mt-2 space-y-1">
                            {revision.changes.map((change, changeIdx) => (
                              <li
                                key={`${variant.id}-change-${changeIdx}`}
                                class="flex items-start gap-2 text-xs text-muted-foreground"
                              >
                                <span class="text-primary font-bold mt-0.5">â€¢</span>
                                <span class="leading-snug text-foreground">{change}</span>
                              </li>
                            ))}
                          </ul>
                        )}
                        {revision.overrides && (
                          <div class="mt-2 flex flex-wrap gap-1.5">
                            {revision.overrides.sensors && (
                              <Badge className="text-[10px] uppercase tracking-wide bg-purple-500/10 text-purple-500 border-purple-500/30">
                                Sensor overrides
                              </Badge>
                            )}
                            {revision.overrides.io && (
                              <Badge className="text-[10px] uppercase tracking-wide bg-blue-500/10 text-blue-500 border-blue-500/30">
                                I/O overrides
                              </Badge>
                            )}
                            {revision.overrides.power && (
                              <Badge className="text-[10px] uppercase tracking-wide bg-amber-500/10 text-amber-500 border-amber-500/30">
                                Power overrides
                              </Badge>
                            )}
                          </div>
                        )}
                        {variant.sourceEntries.length > 0 && (
                          <div class="mt-2 flex flex-wrap gap-1.5">
                            {variant.sourceEntries.map((source) =>
                              source.url ? (
                                <a
                                  key={source.id}
                                  href={source.url}
                                  target="_blank"
                                  rel="noopener noreferrer"
                                  class="text-[10px] uppercase tracking-wide font-semibold inline-flex items-center gap-1 rounded-sm border border-primary/30 bg-primary/5 px-2 py-1 text-primary hover:bg-primary/10 transition-colors"
                                >
                                  {source.title}
                                  <span>â†—</span>
                                </a>
                              ) : (
                                <span
                                  key={source.id}
                                  class="text-[10px] uppercase tracking-wide font-semibold inline-flex items-center gap-1 rounded-sm border border-border/40 bg-muted/30 px-2 py-1 text-muted-foreground"
                                >
                                  {source.title}
                                </span>
                              )
                            )}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </CardContent>
            </Card>
          )}
        </aside>
      </div>
  </section>


  <section id="known-issues" aria-labelledby="known-issues-heading" class="mt-16 space-y-4">
    <h2 class="text-lg font-semibold tracking-tight text-foreground" id="known-issues-heading">
      Known Issues & Advisories
    </h2>
      {variantIssueBuckets.map((bucket, idx) => (
        <div
          data-variant-issues={bucket.id}
          class={`space-y-4 ${idx === 0 ? '' : 'hidden'}`}
          aria-hidden={idx === 0 ? 'false' : 'true'}
        >
          {bucket.issues.length > 0 ? (
            bucket.issues.map((issue, index) => (
              <Card
                key={`${bucket.id}-${issue.id ?? `${issue.date}-${issue.title}-${index}`}`}
                className="border border-border/60 bg-background/80 shadow-xs"
              >
                <CardHeader className="flex flex-col gap-3 border-b border-border/40 pb-4 sm:flex-row sm:items-start sm:justify-between">
                  <div class="flex items-start gap-3">
                    <span class="mt-1 inline-flex h-8 w-8 items-center justify-center rounded-full bg-amber-500/10 text-amber-500">
                      <AlertTriangle className="h-4 w-4" />
                    </span>
                    <div class="space-y-1">
                      <CardTitle className="text-base leading-tight">{issue.title}</CardTitle>
                      {issue.description && (
                        <CardDescription className="text-sm leading-snug text-muted-foreground">
                          {issue.description}
                        </CardDescription>
                      )}
                    </div>
                  </div>
                  <Badge
                    variant="outline"
                    className={`text-[10px] uppercase tracking-wide ${issue.severityMeta.className}`}
                  >
                    {issue.severityMeta.label}
                  </Badge>
                </CardHeader>
                <CardContent className="flex flex-col gap-3 pt-4 text-sm text-muted-foreground sm:flex-row sm:flex-wrap sm:items-center sm:justify-between">
                  <div class="flex items-center gap-2 text-xs uppercase tracking-wide text-muted-foreground">
                    <span class="font-semibold text-foreground">Reported</span>
                    {issue.displayDate ? (
                      <time dateTime={issue.date} class="font-mono text-foreground">
                        {issue.displayDate}
                      </time>
                    ) : (
                      <span class="font-mono text-foreground">{issue.date}</span>
                    )}
                  </div>
                  <div class="flex items-center gap-2 text-xs uppercase tracking-wide text-muted-foreground">
                    <span class="font-semibold text-foreground">Source</span>
                    {issue.sourceUrl ? (
                      <a
                        href={issue.sourceUrl}
                        target="_blank"
                        rel="noopener noreferrer"
                        class="inline-flex items-center gap-1 font-semibold text-primary transition hover:text-primary/80"
                      >
                        {issue.sourceTitle}
                        <ExternalLink className="h-3.5 w-3.5" />
                      </a>
                    ) : (
                      <span class="font-semibold text-foreground">{issue.sourceTitle}</span>
                    )}
                  </div>
                  <div class="flex items-center gap-2 text-xs uppercase tracking-wide text-muted-foreground">
                    <span class="font-semibold text-foreground">Affects</span>
                    {issue.origin.type === 'sensor' ? (
                      <span class="inline-flex items-center gap-2 text-foreground">
                        <a
                          href={`${basePath}/sensors/${issue.origin.sensorId}`}
                          class="inline-flex items-center gap-1 font-semibold text-primary transition hover:text-primary/80"
                        >
                          {issue.origin.sensorName}
                          <ExternalLink className="h-3.5 w-3.5" />
                        </a>
                        <Badge
                          variant="outline"
                          className="text-[10px] uppercase tracking-wide"
                        >
                          {`Onboard ${sensorCategoryLabels[issue.origin.sensorCategory]}`}
                        </Badge>
                      </span>
                    ) : (
                      <Badge variant="outline" className="text-[10px] uppercase tracking-wide">
                        Controller Platform
                      </Badge>
                    )}
                  </div>
                </CardContent>
              </Card>
            ))
          ) : (
            <Card className="border border-dashed border-border/60 bg-muted/20">
              <CardHeader>
                <CardTitle className="text-base font-semibold">
                  No documented issues for {bucket.label}
                </CardTitle>
                <CardDescription>
                  Sensor advisories and controller errata for this revision will appear here once reported.
                </CardDescription>
              </CardHeader>
            </Card>
    )}
        </div>
      ))}
    {hasMultipleVariants && (
      <script type="module">
        const script = document.currentScript;
        if (!(script instanceof HTMLScriptElement)) return;
        const root = document.querySelector('[data-revision-root]');
        if (!(root instanceof HTMLElement)) return;
        const issuesSection = script.parentElement;
        if (!issuesSection) return;
        const defaultId = root.dataset.defaultVariant;
        const tabs = Array.from(root.querySelectorAll('[data-revision-tab]'));
        const panels = Array.from(root.querySelectorAll('[data-revision-panel]'));
        const issueSections = Array.from(
          issuesSection.querySelectorAll('[data-variant-issues]')
        ).filter((el) => el instanceof HTMLElement);
        const select = root.querySelector('[data-revision-select]');
        const activeClasses = ['bg-primary/10', 'border-primary/40', 'text-primary'];
        const inactiveClasses = ['bg-muted/30', 'border-border/60', 'text-muted-foreground'];
        const setActive = (id) => {
          if (typeof id !== 'string' || id.length === 0) return;
          panels.forEach((panel) => {
            if (!(panel instanceof HTMLElement)) return;
            const isActive = panel.dataset.revisionPanel === id;
            panel.classList.toggle('hidden', !isActive);
            panel.setAttribute('aria-hidden', isActive ? 'false' : 'true');
          });
          issueSections.forEach((el) => {
            const isActive = el.dataset.variantIssues === id;
            el.classList.toggle('hidden', !isActive);
            el.setAttribute('aria-hidden', isActive ? 'false' : 'true');
          });
          tabs.forEach((tab) => {
            if (!(tab instanceof HTMLElement)) return;
            const isActive = tab.dataset.revisionTab === id;
            tab.setAttribute('aria-selected', isActive ? 'true' : 'false');
            activeClasses.forEach((cls) => tab.classList.toggle(cls, isActive));
            inactiveClasses.forEach((cls) => tab.classList.toggle(cls, !isActive));
          });
          if (select instanceof HTMLSelectElement && select.value !== id) {
            select.value = id;
          }
        };
        tabs.forEach((tab) => {
          tab.addEventListener('click', () => setActive(tab.dataset.revisionTab));
        });
        if (select instanceof HTMLSelectElement) {
          select.addEventListener('change', (event) => {
            const target = event.target;
            if (target instanceof HTMLSelectElement) {
              setActive(target.value);
            }
          });
        }
        if (defaultId) {
          setActive(defaultId);
        }
      </script>
    )}
  </section>

  <section id="resources" aria-labelledby="controller-resources" class="mt-16 space-y-4">
    <h2 class="text-lg font-semibold tracking-tight text-foreground" id="controller-resources">
      Documentation & Vendor Resources
    </h2>
      {hasLinkItems ? (
        <div class="grid gap-3 md:grid-cols-2">
          {linkItems.map((link) => {
            const Icon = link.icon;
            return (
              <a
                key={link.key}
                href={link.href}
                target="_blank"
                rel="noopener noreferrer"
                class="group flex items-center justify-between gap-4 rounded-lg border border-border/60 bg-background/80 p-4 transition hover:border-primary/50 hover:shadow-sm"
              >
                <div class="flex items-start gap-3">
                  <span class="flex h-10 w-10 items-center justify-center rounded-md bg-muted/60 text-muted-foreground transition group-hover:text-primary">
                    <Icon className="h-5 w-5" />
                  </span>
                  <div class="space-y-1">
                    <p class="text-sm font-semibold text-foreground">{link.label}</p>
                    <p class="text-xs text-muted-foreground">{link.description}</p>
                  </div>
                </div>
                <span class="text-sm text-primary">â†—</span>
              </a>
            );
          })}
        </div>
      ) : (
        <Card className="border border-dashed border-border/60 bg-muted/20">
          <CardHeader>
            <CardTitle className="text-base font-semibold">No supporting resources available</CardTitle>
            <CardDescription>
              Documentation, pinout diagrams, and vendor listings will appear here once they are added to the dataset.
            </CardDescription>
          </CardHeader>
        </Card>
        )}
  </section>
</DetailPageLayout>
