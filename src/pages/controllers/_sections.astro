---
import ControllerCard from '@/components/cards/ControllerCard.astro';
import type { ControllerCardModel } from '@/lib/controller-card-model';
import type { CollectionEntry } from 'astro:content';

interface ManufacturerGroup {
  type: 'manufacturer';
  manufacturer: CollectionEntry<'manufacturers'>;
  controllers: ControllerCardModel[];
}

interface UnassignedGroup {
  type: 'unassigned';
  controllers: ControllerCardModel[];
}

type ControllerSectionGroup = ManufacturerGroup | UnassignedGroup;

type ControllerSectionVariant = 'grid' | 'list';

interface Props {
  group: ControllerSectionGroup;
  basePath: string;
  variant: ControllerSectionVariant;
}

const { group, basePath, variant } = Astro.props as Props;
const isList = variant === 'list';

const baseSectionId =
  group.type === 'manufacturer' ? `manufacturer-${group.manufacturer.id}` : 'unassigned';
const headingId =
  group.type === 'manufacturer'
    ? isList
      ? `${baseSectionId}-list-heading`
      : `${baseSectionId}-heading`
    : isList
      ? `${baseSectionId}-heading-list`
      : `${baseSectionId}-heading`;
const sectionId =
  group.type === 'manufacturer'
    ? isList
      ? `${baseSectionId}-list`
      : baseSectionId
    : undefined;
const heading =
  group.type === 'manufacturer' ? group.manufacturer.data.name : 'Other controllers';
const description =
  group.type === 'manufacturer'
    ? group.manufacturer.data.description
    : 'These controllers are not currently linked to a registered manufacturer.';
const controllerCount = group.controllers.length;
const countLabel = `${controllerCount} ${
  controllerCount === 1 ? 'controller' : 'controllers'
}`;
---
{group.controllers.length > 0 && (
  <section
    id={sectionId}
    class="space-y-4"
    aria-labelledby={headingId}
  >
    <div class="flex flex-wrap items-baseline justify-between gap-2">
      <h2 id={headingId} class="text-2xl font-semibold tracking-tight">
        {heading}
      </h2>
      <span class="text-sm text-muted-foreground">{countLabel}</span>
    </div>
    {description && (
      <p class="text-sm text-muted-foreground max-w-3xl">
        {description}
      </p>
    )}
    {isList ? (
      <div class="overflow-hidden rounded-xl border">
        <div class="hidden border-b bg-muted/40 px-4 py-3 text-[11px] font-semibold uppercase tracking-wide text-muted-foreground sm:grid sm:grid-cols-[minmax(0,2fr)_minmax(0,0.8fr)_minmax(0,1fr)_minmax(0,1fr)_auto] sm:gap-4 sm:px-5">
          <span>Controller</span>
          <span>Specs</span>
          <span>IO &amp; Features</span>
          <span>Firmware</span>
          <span class="text-right sr-only">Actions</span>
        </div>
        <div role="list" class="divide-y">
          {group.controllers.map((controller) => (
            <div key={controller.id} class="px-2 py-3 sm:px-0">
              <ControllerCard
                {...controller}
                basePath={basePath}
                variant="list"
                enableCompareToggle
              />
            </div>
          ))}
        </div>
      </div>
    ) : (
      <ul class="grid gap-4 sm:grid-cols-2 xl:grid-cols-3">
        {group.controllers.map((controller) => (
          <li key={controller.id}>
            <ControllerCard {...controller} basePath={basePath} enableCompareToggle />
          </li>
        ))}
      </ul>
    )}
  </section>
)}
